<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - @Torrent</title>
  
  <!-- Alpine.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  
  <!-- WebSocket Client -->
  <script src="/js/websocket-client.js"></script>
  
  <!-- Tailwind CSS from CDN (for development, should be built for production) -->
  <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { main: '#90caf9', light: '#e3f2fd', dark: '#42a5f5' },
            secondary: { main: '#f48fb1', light: '#fce4ec', dark: '#ad1457' },
            success: { main: '#66bb6a', light: '#81c784', dark: '#388e3c' },
            warning: { main: '#ffa726', light: '#ffb74d', dark: '#f57c00' },
            error: { main: '#f44336', light: '#ef5350', dark: '#c62828' },
            background: { default: '#121212', paper: '#1e1e1e', elevated: '#272727' },
            text: { primary: '#ffffff', secondary: '#b3b3b3', disabled: '#666666' }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Beautiful gradient background */
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      min-height: 100vh;
      background-attachment: fixed;
    }
    .mui-nav-link { display: inline-flex; align-items: center; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    /* Global font size reduction - 20% smaller */
    .text-xs { font-size: 0.7rem !important; /* ~11px instead of 12px */ }
    body { font-size: 14px; /* reduced from default 16px */ }
    /* Responsive navigation fixes */
    @media (max-width: 640px) {
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
    /* Minimal custom styles */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mui-card { background: linear-gradient(135deg, rgba(20, 18, 35, 0.95) 0%, rgba(35, 30, 70, 0.9) 50%, rgba(25, 25, 45, 0.95) 100%); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37), 0 0 40px rgba(144, 202, 249, 0.1); border: 1px solid rgba(255, 255, 255, 0.08); }
    .mui-btn { padding: 12px 24px; font-size: 0.875rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .mui-btn-contained { background: #90caf9; color: #000; }
    .mui-btn-contained:hover { background: #42a5f5; }
    .mui-btn-outlined { background: transparent; color: #90caf9; border: 1px solid rgba(144, 202, 249, 0.5); }
    .mui-btn-outlined:hover { background: rgba(144, 202, 249, 0.1); }
    .mui-input { padding: 10px 14px; background: rgba(144, 202, 249, 0.08); border: 1px solid rgba(144, 202, 249, 0.2); border-radius: 6px; color: rgba(144, 202, 249, 0.9); font-size: 14px; transition: all 0.2s; }
    .mui-input:focus { outline: none; border-color: rgba(144, 202, 249, 0.5); background: rgba(144, 202, 249, 0.12); box-shadow: 0 0 0 3px rgba(144, 202, 249, 0.1); }
    .mui-input:hover { border-color: rgba(144, 202, 249, 0.4); background: rgba(144, 202, 249, 0.1); }
    /* Custom File Input Styling */
    .mui-file-input {
      position: relative;
      display: inline-block;
      width: 100%;
      cursor: pointer;
    }
    
    .mui-file-input input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .mui-file-input .file-input-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.1) 0%, rgba(144, 202, 249, 0.05) 100%);
      border: 2px dashed rgba(144, 202, 249, 0.3);
      border-radius: 8px;
      color: rgba(144, 202, 249, 0.9);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-height: 48px;
    }
    
    .mui-file-input:hover .file-input-button {
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.15) 0%, rgba(144, 202, 249, 0.08) 100%);
      border-color: rgba(144, 202, 249, 0.5);
      transform: translateY(-1px);
    }
    
    .mui-file-input.has-files .file-input-button {
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.2) 0%, rgba(144, 202, 249, 0.1) 100%);
      border-color: rgba(144, 202, 249, 0.6);
      border-style: solid;
    }

    /* Custom Checkbox Styling */
    .mui-checkbox {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .mui-checkbox input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .mui-checkbox .checkbox-custom {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      background: rgba(144, 202, 249, 0.08);
      border: 2px solid rgba(144, 202, 249, 0.3);
      border-radius: 4px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mui-checkbox:hover .checkbox-custom {
      background: rgba(144, 202, 249, 0.12);
      border-color: rgba(144, 202, 249, 0.5);
    }
    
    .mui-checkbox input[type="checkbox"]:checked + .checkbox-custom {
      background: linear-gradient(135deg, #90caf9 0%, #42a5f5 100%);
      border-color: #90caf9;
    }
    
    .mui-checkbox input[type="checkbox"]:checked + .checkbox-custom::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 10px;
      border: solid #000;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      top: 1px;
      left: 6px;
    }
    
    .mui-checkbox input[type="checkbox"]:focus + .checkbox-custom {
      box-shadow: 0 0 0 3px rgba(144, 202, 249, 0.2);
    }
    .mui-btn-danger { background: #dc2626; color: #fff; border: 1px solid #dc2626; }
    .mui-btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }
    .mui-chip { display: inline-flex; padding: 0 12px; height: 24px; align-items: center; border-radius: 12px; font-size: 0.75rem; text-transform: capitalize; }
    .mui-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(144, 202, 249, 0.3); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Mobile button consistency */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn { padding: 12px 20px !important; font-size: 0.875rem !important; }
      nav {
        width: 100%;
        justify-content: center;
      }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
  </style>
</head>
<body class="gradient-bg-dark text-text-primary">
  <div x-data="dashboardApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-gray-900/90 backdrop-blur border-b border-white/10">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4">
          <h1 class="text-lg sm:text-xl font-bold">@Torrent</h1>
          <nav class="flex flex-wrap justify-center sm:justify-start gap-1 sm:gap-2">
            <a href="/dashboard.html" class="mui-nav-link active">Dashboard</a>
            <a href="/torrents.html" class="mui-nav-link">Torrents</a>
            <a href="/statistics.html" class="mui-nav-link">Statistics</a>
            <a href="/settings.html" class="mui-nav-link">Settings</a>
            <button @click="logout()" class="mui-btn mui-btn-danger sm:ml-4">Logout</button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <h2 class="text-2xl font-bold mb-2">Dashboard</h2>
      <p class="text-text-secondary mb-8">Welcome back! Here's an overview of your torrent activity.</p>

      <!-- Stats Grid -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
        <div class="mui-card p-4">
          <p class="text-text-secondary text-xs">Total Torrents</p>
          <p class="text-2xl font-bold" x-text="stats.total_torrents || 0"></p>
          <p class="text-xs text-text-secondary"><span x-text="stats.active_torrents || 0"></span> active</p>
        </div>
        <div class="mui-card p-4">
          <p class="text-text-secondary text-xs">Download Speed</p>
          <p class="text-2xl font-bold" x-text="formatSpeed(stats.total_download_speed || 0)"></p>
          <p class="text-xs text-text-secondary"><span x-text="stats.downloading || 0"></span> downloading</p>
        </div>
        <div class="mui-card p-4">
          <p class="text-text-secondary text-xs">Upload Speed</p>
          <p class="text-2xl font-bold" x-text="formatSpeed(stats.total_upload_speed || 0)"></p>
          <p class="text-xs text-text-secondary"><span x-text="stats.seeding || 0"></span> seeding</p>
        </div>
        <div class="mui-card p-4">
          <p class="text-text-secondary text-xs">Total Downloaded</p>
          <p class="text-2xl font-bold" x-text="formatBytes(stats.total_downloaded || 0)"></p>
          <p class="text-xs text-text-secondary"><span x-text="formatBytes(stats.total_uploaded || 0)"></span> uploaded</p>
        </div>
      </div>

      <!-- Torrents List -->
      <div class="mui-card p-6">
        <h3 class="text-lg font-bold mb-4">Recent Torrents</h3>
        
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
          <div class="flex gap-2 justify-center sm:justify-start flex-wrap">
          <button @click="showAddDialog = true" class="mui-btn mui-btn-contained whitespace-nowrap">+ Add Torrent(s)</button>
          <button @click="resumeAll()" 
                  :disabled="!canResumeAll" 
                  :class="canResumeAll ? '' : 'opacity-50 cursor-not-allowed'"
                  class="mui-btn mui-btn-outlined whitespace-nowrap">Resume All</button>
          <button @click="pauseAll()" 
                  :disabled="!canPauseAll"
                  :class="canPauseAll ? '' : 'opacity-50 cursor-not-allowed'"
                  class="mui-btn mui-btn-outlined whitespace-nowrap">Pause All</button>
          <button @click="deleteAll()" 
                  :disabled="torrents.length === 0"
                  :class="torrents.length > 0 ? '' : 'opacity-50 cursor-not-allowed'"
                  class="mui-btn mui-btn-outlined text-error-main border-error-main/50 hover:bg-error-main/10 whitespace-nowrap">Delete All</button>
          </div>
        </div>

        <div class="space-y-2">
          <template x-if="loading">
            <div class="text-center py-8"><div class="mui-spinner"></div></div>
          </template>
          
          <template x-if="!loading && torrents.length === 0">
            <div class="text-center py-8 text-text-secondary">No torrents found.</div>
          </template>

          <template x-for="(torrent, index) in torrents" :key="torrent.id">
            <div class="p-4 border-b border-white/10 flex items-center gap-4">
              
              <!-- Middle: Name and details stacked -->
              <div class="flex-1 min-w-0">
                <!-- 1. Torrent name on top with truncation -->
                <p @click.stop="showDetails(torrent)" class="font-medium truncate mb-2 cursor-pointer hover:text-primary-main" x-text="formatFileName(torrent.name)" :title="torrent.name"></p>
                
                <!-- 2. Details row below name -->
                <div class="flex items-center gap-3 flex-wrap">
                  <span class="mui-chip" 
                        :class="{'bg-primary-main/20 text-primary-main': torrent.status === 'downloading',
                                 'bg-success-main/20 text-success-main': torrent.status === 'seeding',
                                 'bg-white/10': torrent.status === 'paused'}"
                        x-text="torrent.status"></span>
                  <span class="text-xs text-text-secondary" x-text="formatBytes(torrent.total_size)"></span>
                  <span x-show="torrent.download_speed > 0" class="text-xs text-primary-main">↓ <span x-text="formatSpeed(torrent.download_speed)"></span></span>
                  <span x-show="torrent.upload_speed > 0" class="text-xs text-success-main">↑ <span x-text="formatSpeed(torrent.upload_speed)"></span></span>
                  <div class="relative w-20 sm:w-24">
                    <div class="w-full h-7 bg-gray-800/50 rounded-lg border border-white/10 overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-300 relative" 
                           :style="`width: ${torrent.progress * 100}%`">
                        <div class="absolute inset-0 progress-shimmer" x-show="torrent.status === 'downloading'"></div>
                      </div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <span class="text-xs font-semibold text-white drop-shadow-md" x-text="Math.round(torrent.progress * 100) + '%'"></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 3. Right side: Action buttons vertically centered -->
              <div class="flex gap-1 items-center flex-shrink-0">
                <button @click="toggleTorrent(torrent)" 
                        class="p-1 hover:bg-white/10 rounded" title="Play/Pause">
                  <svg x-show="torrent.status !== 'paused'" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                  </svg>
                  <svg x-show="torrent.status === 'paused'" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
                <button @click="deleteTorrent(torrent.id)" 
                        class="p-1 hover:bg-white/10 rounded text-error-main" title="Delete">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </main>
    <!-- Footer -->
    <footer class="text-center py-8 text-text-secondary text-xs">
      <p>Copyright © 2025. All rights reserved.</p>
    </footer>


    <!-- Add Torrent Dialog -->
    <div x-show="showAddDialog" x-cloak class="fixed inset-0 bg-black/75 flex items-center justify-center z-50" @click.self="showAddDialog = false">
      <div class="mui-card rounded-xl p-6 w-full max-w-lg">
        <h3 class="text-lg font-bold mb-4">Add Torrents</h3>
        
        <!-- File Upload Area -->
        <div class="mb-4">
          <label class="block text-xs font-medium mb-2">Select Torrent Files</label>
          <div class="mui-file-input" :class="{'has-files': selectedFiles.length > 0}" @click="$refs.fileInput.click()">
            <input type="file" @change="handleFileSelect($event)" accept=".torrent" multiple x-ref="fileInput">
            <div class="file-input-button">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
              <span x-show="selectedFiles.length === 0">Choose torrent files</span>
              <span x-show="selectedFiles.length > 0" x-text="selectedFiles.length + ' file(s) selected'"></span>
            </div>
          </div>
          <div x-show="selectedFiles.length > 0" class="mt-2 text-xs text-text-secondary">
            Selected: <span x-text="selectedFiles.length + ' file(s)'" ></span>
          </div>
        </div>
        
        <!-- Auto-start option -->
        <div class="mb-4">
          <label class="flex items-center gap-3 cursor-pointer">
            <div class="mui-checkbox">
              <input type="checkbox" x-model="autoStartDownloads">
              <div class="checkbox-custom"></div>
            </div>
            <span class="text-sm">Start downloads automatically</span>
          </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-2 justify-end">
          <button @click="showAddDialog = false; resetAddForm()" class="mui-btn mui-btn-outlined">Cancel</button>
          <button @click="addTorrents()" class="mui-btn mui-btn-contained" :disabled="selectedFiles.length === 0">
            Add <span x-show="selectedFiles.length > 0" x-text="'(' + selectedFiles.length + ')'" ></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Torrent Details Modal -->
    <div x-show="showDetailsDialog" x-cloak class="fixed inset-0 bg-black/75 flex items-center justify-center z-50" @click.self="showDetailsDialog = false">
      <div class="mui-card backdrop-blur rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
        <!-- Dialog Header -->
        <div class="flex justify-between items-start p-6 border-b border-white/10">
          <div class="flex-1">
            <h3 class="text-xl font-bold mb-2" x-text="formatFileName(selectedTorrent?.name)"></h3>
            <div class="flex flex-wrap gap-4 text-sm text-text-secondary">
              <span>Size: <span class="text-white" x-text="formatBytes(selectedTorrent?.total_size || 0)"></span></span>
              <span>Progress: <span class="text-white" x-text="Math.round((selectedTorrent?.progress || 0) * 100) + '%'"></span></span>
              <span>Status: <span class="text-white capitalize" x-text="selectedTorrent?.status"></span></span>
            </div>
          </div>
          <button @click="showDetailsDialog = false" class="text-gray-400 hover:text-white text-2xl ml-4">&times;</button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="px-6 pt-4">
          <div class="flex border-b border-white/10">
            <button @click="activeTab = 'content'" 
                    :class="activeTab === 'content' ? 'border-primary-main text-primary-main' : 'border-transparent text-text-secondary hover:text-white'"
                    class="px-4 py-2 border-b-2 font-medium transition-colors">
              Files & Content
            </button>
            <button @click="activeTab = 'movie'" 
                    :class="activeTab === 'movie' ? 'border-primary-main text-primary-main' : 'border-transparent text-text-secondary hover:text-white'"
                    class="px-4 py-2 border-b-2 font-medium transition-colors ml-6">
              Movie Info
            </button>
          </div>
        </div>
        
        <!-- Tab Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
          <!-- Files & Content Tab -->
          <div x-show="activeTab === 'content'" x-transition>
            <div x-show="loadingContent" class="flex items-center justify-center py-8">
              <div class="mui-spinner"></div>
              <span class="ml-2">Loading torrent content...</span>
            </div>
            
            <div x-show="contentError" class="text-center py-8 text-error-main">
              Failed to load torrent content
            </div>
            
            <div x-show="torrentContent && !loadingContent && !contentError">
              <!-- Content Summary -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-gray-700/50 to-gray-800/50 backdrop-blur-sm border border-white/10 p-4 rounded-lg">
                  <h4 class="text-sm text-text-secondary mb-1">Total Files</h4>
                  <p class="text-2xl font-bold" x-text="torrentContent?.total_files || 0"></p>
                </div>
                <div class="bg-gradient-to-br from-gray-700/50 to-gray-800/50 backdrop-blur-sm border border-white/10 p-4 rounded-lg">
                  <h4 class="text-sm text-text-secondary mb-1">Video Files</h4>
                  <p class="text-2xl font-bold text-primary-main" x-text="torrentContent?.video_files || 0"></p>
                </div>
                <div class="bg-gradient-to-br from-gray-700/50 to-gray-800/50 backdrop-blur-sm border border-white/10 p-4 rounded-lg">
                  <h4 class="text-sm text-text-secondary mb-1">Subtitle Files</h4>
                  <p class="text-2xl font-bold text-success-main" x-text="torrentContent?.subtitle_files || 0"></p>
                </div>
              </div>
              
              <!-- File Groups -->
              <template x-for="(entry, index) in Object.entries(torrentContent?.file_groups || {})" :key="entry[0]">
                <div x-show="entry[1].length > 0" class="mb-6">
                  <h4 class="text-lg font-semibold mb-3 capitalize flex items-center gap-2">
                    <span x-text="entry[0]"></span>
                    <span class="text-sm text-text-secondary">(<span x-text="entry[1].length"></span> files)</span>
                  </h4>
                  
                  <div class="space-y-2">
                    <template x-for="file in entry[1]" :key="file.name">
                      <div class="bg-gradient-to-br from-gray-700/50 to-gray-800/50 backdrop-blur-sm border border-white/10 p-4 rounded-lg">
                        <div class="flex-1 min-w-0">
                          <p class="font-medium truncate" x-text="file.name"></p>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
          
          <!-- Movie Info Tab -->
          <div x-show="activeTab === 'movie'" x-transition>
            <div x-show="loadingMovieInfo" class="flex items-center justify-center py-8">
              <div class="mui-spinner"></div>
              <span class="ml-2">Loading movie information...</span>
            </div>
            
            <div x-show="movieInfo && movieInfo.found && !loadingMovieInfo">
              <!-- Data Source Indicator -->
              <div x-show="movieInfo?.is_mock_data" class="mb-4 p-3 bg-warning-main/10 border border-warning-main/30 rounded-lg">
                <div class="flex items-center gap-2 text-warning-main">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                  </svg>
                  <span class="text-sm font-medium">Sample Data</span>
                </div>
                <p class="text-xs mt-1 text-warning-main/80">This is placeholder data. Configure your TMDB API key in Settings for real movie information.</p>
                <p x-show="movieInfo?.api_error" class="text-xs mt-1 text-error-main" x-text="movieInfo?.api_error"></p>
              </div>
              
              <!-- Movie Header -->
              <div class="flex gap-6 mb-6">
                <img x-show="movieInfo?.poster_path" :src="movieInfo?.poster_path" 
                     class="w-48 h-72 object-cover rounded-lg shadow-lg flex-shrink-0">
                <div class="flex-1">
                  <h2 class="text-3xl font-bold mb-2" x-text="movieInfo?.title"></h2>
                  <p x-show="movieInfo?.tagline" class="text-lg italic text-text-secondary mb-4" x-text="movieInfo?.tagline"></p>
                  
                  <!-- Movie Stats -->
                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <div x-show="movieInfo?.release_date">
                      <span class="text-text-secondary">Release Date:</span>
                      <span class="ml-2 font-medium" x-text="movieInfo?.release_date ? new Date(movieInfo.release_date).getFullYear() : 'N/A'"></span>
                    </div>
                    <div x-show="movieInfo?.runtime">
                      <span class="text-text-secondary">Runtime:</span>
                      <span class="ml-2 font-medium" x-text="movieInfo?.runtime ? (movieInfo.runtime + ' minutes') : 'N/A'"></span>
                    </div>
                    <div x-show="movieInfo?.vote_average">
                      <span class="text-text-secondary">Rating:</span>
                      <span class="ml-2 font-medium flex items-center">
                        ⭐ <span x-text="movieInfo?.vote_average ? movieInfo.vote_average.toFixed(1) : 'N/A'"></span>
                        <span class="text-text-secondary ml-1">(<span x-text="movieInfo?.vote_count?.toLocaleString()"></span> votes)</span>
                      </span>
                    </div>
                    <div x-show="movieInfo?.director">
                      <span class="text-text-secondary">Director:</span>
                      <span class="ml-2 font-medium" x-text="movieInfo?.director"></span>
                    </div>
                  </div>
                  
                  <!-- Genres -->
                  <div x-show="movieInfo?.genres && movieInfo?.genres.length > 0" class="mb-4">
                    <span class="text-text-secondary">Genres:</span>
                    <div class="flex flex-wrap gap-2 mt-2">
                      <template x-for="genre in movieInfo?.genres" :key="genre">
                        <span class="bg-primary-main/20 text-primary-main px-2 py-1 rounded-full text-xs" x-text="genre"></span>
                      </template>
                    </div>
                  </div>
                  
                  <!-- Overview -->
                  <div x-show="movieInfo?.overview" class="mb-4">
                    <h4 class="font-semibold mb-2">Overview</h4>
                    <p class="text-text-secondary leading-relaxed" x-text="movieInfo?.overview"></p>
                  </div>
                </div>
              </div>
              
              <!-- Cast & Crew -->
              <div x-show="movieInfo?.cast && movieInfo?.cast.length > 0" class="mb-6">
                <h4 class="text-lg font-semibold mb-4">Cast</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                  <template x-for="actor in (movieInfo?.cast || []).slice(0, 10)" :key="actor.name">
                    <div class="text-center">
                      <img x-show="actor.profile_path" :src="actor.profile_path" 
                           class="w-20 h-20 rounded-full object-cover mx-auto mb-2">
                      <div x-show="!actor.profile_path" 
                           class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center mx-auto mb-2">
                        <span class="text-2xl">👤</span>
                      </div>
                      <p class="font-medium text-sm" x-text="actor.name"></p>
                      <p class="text-xs text-text-secondary" x-text="actor.character"></p>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            
            <div x-show="movieInfo && !movieInfo.found && !loadingMovieInfo" class="text-center py-8">
              <div x-show="movieInfo?.error" class="mb-4 p-4 bg-error-main/10 border border-error-main/30 rounded-lg">
                <div class="flex items-center gap-2 text-error-main mb-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span class="font-semibold" x-text="movieInfo?.error || 'Error loading movie info'"></span>
                </div>
                <p class="text-sm text-error-main/80" x-text="movieInfo?.message || 'Please check your settings and try again.'"></p>
              </div>
              <p class="text-text-secondary">No movie information found for this torrent.</p>
            </div>
            
            <div x-show="!movieInfo && !loadingMovieInfo" class="text-center py-8">
              <p class="text-text-secondary">Movie information not available.</p>
            </div>
          </div>
        </div>
        
        <!-- Dialog Footer -->
        <div class="px-6 py-4 border-t border-white/10 flex justify-end gap-2">
          <button @click="showDetailsDialog = false" class="mui-btn mui-btn-outlined">Close</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // API Configuration
    
            // Dynamic API base URL configuration
            const API_BASE = (() => {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                const port = window.location.port;
                
                // For development (localhost)
                if (hostname === "localhost" || hostname === "127.0.0.1") {
                    return `${protocol}//localhost:8000/api/v1`;
                }
                
                // For production, use same host with different port or same port
                if (port && port !== "80" && port !== "443") {
                    // If we're on a specific port, assume API is on 8000
                    return `${protocol}//${hostname}:8000/api/v1`;
                }
                
                // Default to same host (for reverse proxy setups)
                return `${protocol}//${hostname}/api/v1`;
            })();
    // Utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0.00 GB';
      const gb = bytes / (1024 * 1024 * 1024);
      return gb.toFixed(2) + ' GB';
    }
    
    function formatSpeed(bytesPerSecond) {
      if (bytesPerSecond === 0) return '0.00 MB/s';
      const mb = bytesPerSecond / (1024 * 1024);
      return mb.toFixed(2) + ' MB/s';
    }
    function formatFileName(fileName) {
      if (!fileName) return fileName;
      
      // Video extensions to remove from TORRENT NAMES display only
      const videoExtensions = ['.mkv', '.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.m4v', '.mpg', '.mpeg', '.3gp', '.m2ts', '.ts'];
      
      // Check if torrent name ends with any video extension - if so, remove it
      for (const ext of videoExtensions) {
        if (fileName.toLowerCase().endsWith(ext.toLowerCase())) {
          return fileName.slice(0, -ext.length);
        }
      }
      
      // Return original name if no video extension found
      return fileName;
    }

    
    // Alpine.js App
    function dashboardApp() {
      return {
        torrents: [],
        stats: {},
        loading: false,
        showAddDialog: false,
        selectedFiles: [],
        autoStartDownloads: true,
        
        // Torrent details variables
        showDetailsDialog: false,
        selectedTorrent: null,
        movieInfo: null,
        loadingMovieInfo: false,
        torrentContent: null,
        loadingContent: false,
        contentError: false,
        activeTab: 'content',
        
        // Computed properties for button states
        get canResumeAll() {
          return this.torrents.some(t => t.status === 'paused');
        },
        
        get canPauseAll() {
          return this.torrents.some(t => t.status !== 'paused');
        },
        
        async init() {
          const token = getCookie('access_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }
          
          // Initial data fetch
          await this.fetchDashboardData();
          
          // Setup WebSocket for real-time updates
          this.setupWebSocket();
        },
        
        setupWebSocket() {
          // Store reference to Alpine component
          const alpineComponent = this;
          
          // Try WebSocket connection
          try {
            // Create update handler that uses the stored component reference
            const updateHandler = function(data) {
              // Update torrents data in real-time
              if (data && Array.isArray(data)) {
                // Update using the stored Alpine component reference
                alpineComponent.torrents = [...data];
                alpineComponent.calculateStats();
              }
            };
            
            // Remove any existing listener before adding new one
            window.torrentWS.off('torrent_update', this.updateHandler);
            this.updateHandler = updateHandler;
            window.torrentWS.on('torrent_update', updateHandler);
            
            // Handle connection status
            const connectedHandler = () => {
              // Stop polling if we have WebSocket
              if (this.pollingInterval) {
                clearInterval(this.pollingInterval);
                this.pollingInterval = null;
              }
              // Fetch fresh data on reconnect
              this.fetchDashboardData();
            };
            
            const disconnectedHandler = () => {
              // Start fallback polling if WebSocket disconnects
              this.startPolling();
            };
            
            window.torrentWS.off('connected', this.connectedHandler);
            window.torrentWS.off('disconnected', this.disconnectedHandler);
            this.connectedHandler = connectedHandler;
            this.disconnectedHandler = disconnectedHandler;
            window.torrentWS.on('connected', connectedHandler);
            window.torrentWS.on('disconnected', disconnectedHandler);
            
            // Connect if not already connected
            window.torrentWS.connect();
            
            // If already connected, stop polling
            if (window.torrentWS.isConnected) {
              if (this.pollingInterval) {
                clearInterval(this.pollingInterval);
                this.pollingInterval = null;
              }
            } else {
              // Start with polling as fallback
              this.startPolling();
            }
          } catch (error) {
            // Fallback to polling
            this.startPolling();
          }
        },
        
        startPolling() {
          if (!this.pollingInterval) {
            this.pollingInterval = setInterval(() => {
              this.fetchDashboardData();
            }, 200);
          }
        },
        
        calculateStats() {
          // Calculate stats from torrents data
          const stats = {
            total_torrents: this.torrents.length,
            active_torrents: 0,
            downloading: 0,
            seeding: 0,
            paused: 0,
            total_download_speed: 0,
            total_upload_speed: 0,
            total_downloaded: 0,
            total_uploaded: 0
          };
          
          this.torrents.forEach(torrent => {
            if (torrent.status === 'downloading') {
              stats.downloading++;
              stats.active_torrents++;
            } else if (torrent.status === 'seeding') {
              stats.seeding++;
              stats.active_torrents++;
            } else if (torrent.status === 'paused') {
              stats.paused++;
            }
            
            stats.total_download_speed += torrent.download_speed || 0;
            stats.total_upload_speed += torrent.upload_speed || 0;
            stats.total_downloaded += torrent.downloaded || 0;
            stats.total_uploaded += torrent.uploaded || 0;
          });
          
          this.stats = stats;
        },
        
        async fetchDashboardData() {
          this.loading = true;
          const token = getCookie('access_token');
          
          try {
            // Fetch torrents
            const torrentsRes = await fetch(`${API_BASE}/torrents/?limit=10`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (torrentsRes.ok) {
              this.torrents = await torrentsRes.json();
            }
            
            // Fetch stats
            const statsRes = await fetch(`${API_BASE}/torrents/stats/overview`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (statsRes.ok) {
              this.stats = await statsRes.json();
            }
          } catch (error) {
            // Handle error silently or show user-friendly message
          } finally {
            this.loading = false;
          }
        },
        
        async toggleTorrent(torrent) {
          const token = getCookie('access_token');
          const action = torrent.status === 'paused' ? 'resume' : 'pause';
          
          try {
            await fetch(`${API_BASE}/torrents/${torrent.id}/${action}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            await this.fetchDashboardData();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async deleteTorrent(id) {
          if (!confirm("Delete this torrent and its files?")) return;
          
          const token = getCookie("access_token");
          try {
            await fetch(`${API_BASE}/torrents/${id}?delete_files=true`, {
              method: "DELETE",
              headers: { "Authorization": `Bearer ${token}` }
            });
            await this.fetchDashboardData();
          } catch (error) {
            // Handle error silently
          }
        },
        async resumeAll() {
          if (!this.canResumeAll) return;
          
          const token = getCookie('access_token');
          const torrentIds = this.torrents
            .filter(t => t.status === 'paused')
            .map(t => t.id);
          
          try {
            await fetch(`${API_BASE}/torrents/bulk/resume`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ torrent_ids: torrentIds })
            });
            await this.fetchDashboardData();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async pauseAll() {
          if (!this.canPauseAll) return;
          
          const token = getCookie('access_token');
          const torrentIds = this.torrents
            .filter(t => t.status !== 'paused')
            .map(t => t.id);
          
          try {
            await fetch(`${API_BASE}/torrents/bulk/pause`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ torrent_ids: torrentIds })
            });
            await this.fetchDashboardData();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async deleteAll() {
          if (this.torrents.length === 0) {
            alert('No torrents to delete');
            return;
          }
          
          if (!confirm(`Delete all ${this.torrents.length} torrent(s) and their files?`)) {
            return;
          }
          
          const token = getCookie('access_token');
          const torrentIds = this.torrents.map(t => t.id);
          
          try {
            await fetch(`${API_BASE}/torrents/bulk?delete_files=true`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                torrent_ids: torrentIds
              })
            });
            await this.fetchDashboardData();
          } catch (error) {
            // Handle error silently
          }
        },
        
        handleFileSelect(event) {
          this.selectedFiles = Array.from(event.target.files);
        },
        
        async addTorrents() {
          if (this.selectedFiles.length === 0) return;
          
          const token = getCookie('access_token');
          
          for (const file of this.selectedFiles) {
            try {
              const reader = new FileReader();
              const fileContent = await new Promise((resolve) => {
                reader.onload = (e) => resolve(btoa(e.target.result));
                reader.readAsBinaryString(file);
              });
              
              await fetch(`${API_BASE}/torrents/`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                  torrent_file: fileContent,
                  auto_start: this.autoStartDownloads 
                })
              });
            } catch (error) {
              // Handle error silently
            }
          }
          
          this.showAddDialog = false;
          this.resetAddForm();
          await this.fetchDashboardData();
        },
        
        resetAddForm() {
          this.selectedFiles = [];
          const fileInput = document.querySelector('input[type="file"]');
          if (fileInput) fileInput.value = '';
        },
        
        
        async showDetails(torrent) {
          this.selectedTorrent = torrent;
          this.showDetailsDialog = true;
          this.activeTab = 'content';
          this.movieInfo = null;
          this.torrentContent = null;
          this.loadingMovieInfo = false;
          this.loadingContent = false;
          this.contentError = false;

          // Fetch torrent content and movie info in parallel
          await Promise.all([
            this.fetchTorrentContent(torrent.id),
            this.fetchMovieInfo(torrent.id)
          ]);
        },

        async fetchTorrentContent(torrentId) {
          this.loadingContent = true;
          this.contentError = false;
          
          try {
            const token = getCookie('access_token');
            const response = await fetch(`${API_BASE}/torrents/${torrentId}/content`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
              this.torrentContent = await response.json();
            } else {
              this.contentError = true;
            }
          } catch (error) {
            this.contentError = true;
          } finally {
            this.loadingContent = false;
          }
        },

        async fetchMovieInfo(torrentId) {
          this.loadingMovieInfo = true;
          
          try {
            const token = getCookie('access_token');
            const response = await fetch(`${API_BASE}/torrents/${torrentId}/movie-info`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
              this.movieInfo = await response.json();
            }
          } catch (error) {
            // Silent fail for movie info - not critical
            this.movieInfo = { found: false };
          } finally {
            this.loadingMovieInfo = false;
          }
        },

        logout() {
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/login.html';
        }
      };
    }
  </script>
</body>
</html>
