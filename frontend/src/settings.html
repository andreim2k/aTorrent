<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - aTorrent</title>
  
  <!-- Alpine.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  
  <!-- Tailwind CSS from CDN -->
  <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { main: '#90caf9', light: '#e3f2fd', dark: '#42a5f5' },
            secondary: { main: '#f48fb1', light: '#fce4ec', dark: '#ad1457' },
            success: { main: '#66bb6a', light: '#81c784', dark: '#388e3c' },
            warning: { main: '#ffa726', light: '#ffb74d', dark: '#f57c00' },
            error: { main: '#f44336', light: '#ef5350', dark: '#c62828' },
            background: { default: '#121212', paper: '#1e1e1e', elevated: '#272727' },
            text: { primary: '#ffffff', secondary: '#b3b3b3', disabled: '#666666' }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Beautiful gradient background */
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      min-height: 100vh;
      background-attachment: fixed;
    }
    /* Global font size reduction - 20% smaller */
    .text-xs { font-size: 0.7rem !important; /* ~11px instead of 12px */ }
    body { font-size: 14px; /* reduced from default 16px */ }
    /* Responsive navigation fixes */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      nav {
        width: 100%;
        justify-content: center;
      }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mui-card { background: linear-gradient(135deg, rgba(20, 18, 35, 0.95) 0%, rgba(35, 30, 70, 0.9) 50%, rgba(25, 25, 45, 0.95) 100%); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37), 0 0 40px rgba(144, 202, 249, 0.1); border: 1px solid rgba(255, 255, 255, 0.08); }
    .mui-btn { padding: 12px 24px; font-size: 0.875rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .mui-btn-contained { background: #90caf9; color: #000; }
    .mui-btn-contained:hover { background: #42a5f5; }
    .mui-btn-contained:disabled { background: #555; color: #999; cursor: not-allowed; }
    .mui-btn-outlined { background: transparent; color: #90caf9; border: 1px solid rgba(144, 202, 249, 0.5); }
    .mui-btn-outlined:hover { background: rgba(144, 202, 249, 0.1); }
    .mui-input { width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; }
    .mui-input:focus { outline: none; border-color: #90caf9; background: rgba(255,255,255,0.08); }
    .mui-nav-link { display: inline-flex; align-items: center; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    .mui-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(144, 202, 249, 0.3); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    .mui-btn-danger { background: #dc2626; color: #fff; border: 1px solid #dc2626; }
    .mui-btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }
    .mui-alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
    .mui-alert-success { background: rgba(102, 187, 106, 0.1); color: #66bb6a; border: 1px solid rgba(102, 187, 106, 0.3); }
    .mui-alert-error { background: rgba(244, 67, 54, 0.1); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.3); }
    .mui-alert-warning { background: rgba(255, 167, 38, 0.1); color: #ffa726; border: 1px solid rgba(255, 167, 38, 0.3); }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Mobile button consistency */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn { padding: 12px 20px !important; font-size: 0.875rem !important; }
    }
  </style>
</head>
<body class="gradient-bg-dark text-text-primary">
  <div x-data="settingsApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-gray-900/90 backdrop-blur border-b border-white/10">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4">
          <h1 class="text-lg sm:text-xl font-bold">aTorrent</h1>
          <nav class="flex flex-wrap justify-center sm:justify-start gap-1 sm:gap-2">
            <a href="/dashboard.html" class="mui-nav-link">Dashboard</a>
            <a href="/torrents.html" class="mui-nav-link">Torrents</a>
            <a href="/statistics.html" class="mui-nav-link">Statistics</a>
            <a href="/settings.html" class="mui-nav-link active">Settings</a>
            <button @click="logout()" class="mui-btn mui-btn-danger sm:ml-4">Logout</button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Settings</h2>
        <p class="text-text-secondary">Manage your account and system preferences</p>
      </div>

      <!-- Loading State -->
      <template x-if="loading">
        <div class="text-center py-8">
          <div class="mui-spinner"></div>
        </div>
      </template>

      <!-- Settings Content -->
      <template x-if="!loading">
        <div class="space-y-6">
          <!-- Alerts -->
          <template x-if="alert.show">
            <div :class="'mui-alert mui-alert-' + alert.type" x-text="alert.message"></div>
          </template>

          <!-- Change Password Section -->
          <div class="mui-card p-6">
            <div class="flex items-center mb-6">
              <svg class="w-6 h-6 mr-3 text-primary-main" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
              <div>
                <h3 class="text-lg font-bold">Change Password</h3>
                <p class="text-xs text-text-secondary">Update your account password for security</p>
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-xs font-medium mb-2">Current Password</label>
                <div class="relative">
                  <input :type="showPasswords.current ? 'text' : 'password'" 
                         x-model="passwordForm.currentPassword" 
                         class="mui-input pr-12">
                  <button @click="showPasswords.current = !showPasswords.current"
                          class="absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary hover:text-text-primary">
                    <svg x-show="!showPasswords.current" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                    <svg x-show="showPasswords.current" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-2">New Password</label>
                  <div class="relative">
                    <input :type="showPasswords.new ? 'text' : 'password'" 
                           x-model="passwordForm.newPassword" 
                           class="mui-input pr-12">
                    <button @click="showPasswords.new = !showPasswords.new"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary hover:text-text-primary">
                      <svg x-show="!showPasswords.new" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                      </svg>
                      <svg x-show="showPasswords.new" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                      </svg>
                    </button>
                  </div>
                  <p class="text-xs text-text-secondary mt-1">Minimum 6 characters</p>
                </div>

                <div>
                  <label class="block text-xs font-medium mb-2">Confirm New Password</label>
                  <div class="relative">
                    <input :type="showPasswords.confirm ? 'text' : 'password'" 
                           x-model="passwordForm.confirmPassword" 
                           class="mui-input pr-12">
                    <button @click="showPasswords.confirm = !showPasswords.confirm"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary hover:text-text-primary">
                      <svg x-show="!showPasswords.confirm" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                      </svg>
                      <svg x-show="showPasswords.confirm" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                      </svg>
                    </button>
                  </div>
                  <p class="text-xs text-text-secondary mt-1">Re-enter your new password</p>
                </div>
              </div>

              <div class="pt-2">
                <button @click="changePassword()" 
                        :disabled="changingPassword"
                        class="mui-btn mui-btn-contained flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                  </svg>
                  <span x-text="changingPassword ? 'Changing...' : 'Change Password'"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Download Settings Section -->
          <div class="mui-card p-6">
            <div class="flex items-center mb-6">
              <svg class="w-6 h-6 mr-3 text-primary-main" fill="currentColor" viewBox="0 0 24 24">
                <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
              </svg>
              <div>
                <h3 class="text-lg font-bold">Download Settings</h3>
                <p class="text-xs text-text-secondary">Configure where torrents will be downloaded</p>
              </div>
            </div>

            <div>
              <label class="block text-xs font-medium mb-2">Default Download Path</label>
              <input type="text" 
                     x-model="localDownloadPath" 
                     @input="downloadPathDirty = (localDownloadPath !== settings.default_download_path)"
                     @blur="saveDownloadPath()"
                     @keydown.enter="saveDownloadPath()"
                     class="mui-input"
                     placeholder="/path/to/downloads">
              <p class="text-xs text-text-secondary mt-1">
                Where torrents will be downloaded (press Enter or click outside to save)
                <span x-show="downloadPathDirty" class="text-warning-main ml-2 font-medium">⚠ Unsaved changes</span>
              </p>
            </div>
          </div>
        </div>
      </template>
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-text-secondary text-xs">
      <p>Copyright © 2025. All rights reserved.</p>
    </footer>
  </div>

  <script>
    // API Configuration
    const API_BASE = 'http://192.168.50.2:8000/api/v1';
    
    // Utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    // Alpine.js App
    function settingsApp() {
      return {
        loading: false,
        changingPassword: false,
        savingSettings: false,
        downloadPathDirty: false,
        localDownloadPath: '',
        settings: {
          default_download_path: ''
        },
        passwordForm: {
          currentPassword: '',
          newPassword: '',
          confirmPassword: ''
        },
        showPasswords: {
          current: false,
          new: false,
          confirm: false
        },
        alert: {
          show: false,
          type: 'success',
          message: ''
        },
        
        async init() {
          const token = getCookie('access_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }
          
          await this.loadSettings();
        },
        
        async loadSettings() {
          this.loading = true;
          const token = getCookie('access_token');
          
          try {
            const response = await fetch(`${API_BASE}/settings`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
              const data = await response.json();
              this.settings = data;
              this.localDownloadPath = data.default_download_path || '';
              this.downloadPathDirty = false;
            }
          } catch (error) {
            console.error('Failed to load settings:', error);
          } finally {
            this.loading = false;
          }
        },
        
        showAlert(type, message) {
          this.alert = { show: true, type, message };
          setTimeout(() => {
            this.alert.show = false;
          }, 5000);
        },
        
        async saveDownloadPath() {
          if (!this.downloadPathDirty) return;
          
          this.savingSettings = true;
          const token = getCookie('access_token');
          
          try {
            const response = await fetch(`${API_BASE}/settings`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                ...this.settings,
                default_download_path: this.localDownloadPath
              })
            });
            
            if (response.ok) {
              this.settings.default_download_path = this.localDownloadPath;
              this.downloadPathDirty = false;
              this.showAlert('success', 'Settings saved successfully');
            } else {
              const error = await response.json();
              this.showAlert('error', error.detail || 'Failed to save settings');
            }
          } catch (error) {
            console.error('Failed to save settings:', error);
            this.showAlert('error', 'Failed to save settings');
          } finally {
            this.savingSettings = false;
          }
        },
        
        async changePassword() {
          // Validation
          if (!this.passwordForm.currentPassword) {
            this.showAlert('error', 'Please enter your current password');
            return;
          }
          
          if (!this.passwordForm.newPassword) {
            this.showAlert('error', 'Please enter a new password');
            return;
          }
          
          if (!this.passwordForm.confirmPassword) {
            this.showAlert('error', 'Please confirm your new password');
            return;
          }
          
          if (this.passwordForm.newPassword.length < 6) {
            this.showAlert('error', 'New password must be at least 6 characters long');
            return;
          }
          
          if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
            this.showAlert('error', 'New passwords do not match. Please ensure both password fields are identical.');
            return;
          }
          
          if (this.passwordForm.currentPassword === this.passwordForm.newPassword) {
            this.showAlert('error', 'New password must be different from your current password');
            return;
          }
          
          // Recommend stronger password
          if (this.passwordForm.newPassword.length < 8) {
            this.showAlert('warning', 'For better security, we recommend using a password that is at least 8 characters long');
          }
          
          this.changingPassword = true;
          const token = getCookie('access_token');
          
          try {
            const response = await fetch(`${API_BASE}/auth/change-password`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                current_password: this.passwordForm.currentPassword,
                new_password: this.passwordForm.newPassword,
                confirm_password: this.passwordForm.confirmPassword
              })
            });
            
            if (response.ok) {
              this.showAlert('success', 'Password changed successfully');
              // Clear form
              this.passwordForm = {
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
              };
              this.showPasswords = {
                current: false,
                new: false,
                confirm: false
              };
            } else {
              const error = await response.json();
              let errorMsg = error.detail || 'Failed to change password';
              
              // Improve error messages
              if (typeof errorMsg === 'string') {
                if (errorMsg.toLowerCase().includes('current password')) {
                  errorMsg = 'Current password is incorrect. Please try again.';
                } else if (errorMsg === 'Not Found') {
                  errorMsg = 'User not found or invalid credentials';
                }
              } else if (Array.isArray(errorMsg)) {
                errorMsg = errorMsg.join(', ');
              }
              
              this.showAlert('error', errorMsg);
            }
          } catch (error) {
            console.error('Failed to change password:', error);
            this.showAlert('error', 'Failed to change password');
          } finally {
            this.changingPassword = false;
          }
        },
        
        logout() {
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/login.html';
        }
      };
    }
  </script>
</body>
</html>
