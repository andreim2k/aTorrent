<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta name="cache-bust" content="1756198118">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Torrents - @Torrent</title>
  
  <!-- Alpine.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  
  <!-- WebSocket Client -->
  <script src="/js/websocket-client.js"></script>
  
  <!-- Tailwind CSS from CDN -->
  <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { main: '#90caf9', light: '#e3f2fd', dark: '#42a5f5' },
            secondary: { main: '#f48fb1', light: '#fce4ec', dark: '#ad1457' },
            success: { main: '#66bb6a', light: '#81c784', dark: '#388e3c' },
            warning: { main: '#ffa726', light: '#ffb74d', dark: '#f57c00' },
            error: { main: '#f44336', light: '#ef5350', dark: '#c62828' },
            background: { default: '#121212', paper: '#1e1e1e', elevated: '#272727' },
            text: { primary: '#ffffff', secondary: '#b3b3b3', disabled: '#666666' }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Beautiful gradient background */
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      min-height: 100vh;
      background-attachment: fixed;
    }
    .mui-nav-link { display: inline-flex; align-items: center; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    /* Global font size reduction - 20% smaller */
    .text-xs { font-size: 0.7rem !important; /* ~11px instead of 12px */ }
    body { font-size: 14px; /* reduced from default 16px */ }
    /* Responsive navigation fixes */
    @media (max-width: 640px) {
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
    /* Minimal custom styles */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mui-card { background: linear-gradient(135deg, rgba(20, 18, 35, 0.95) 0%, rgba(35, 30, 70, 0.9) 50%, rgba(25, 25, 45, 0.95) 100%); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37), 0 0 40px rgba(144, 202, 249, 0.1); border: 1px solid rgba(255, 255, 255, 0.08); }
    .mui-btn { padding: 12px 24px; font-size: 0.875rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .mui-btn-contained { background: #90caf9; color: #000; }
    .mui-btn-contained:hover { background: #42a5f5; }
    .mui-btn-outlined { background: transparent; color: #90caf9; border: 1px solid rgba(144, 202, 249, 0.5); }
    .mui-btn-outlined:hover { background: rgba(144, 202, 249, 0.1); }
    .mui-input { padding: 10px 14px; background: rgba(144, 202, 249, 0.08); border: 1px solid rgba(144, 202, 249, 0.2); border-radius: 6px; color: rgba(144, 202, 249, 0.9); font-size: 14px; transition: all 0.2s; }
    .mui-input:focus { outline: none; border-color: rgba(144, 202, 249, 0.5); background: rgba(144, 202, 249, 0.12); box-shadow: 0 0 0 3px rgba(144, 202, 249, 0.1); }
    .mui-input:hover { border-color: rgba(144, 202, 249, 0.4); background: rgba(144, 202, 249, 0.1); }
    /* Custom File Input Styling */
    .mui-file-input {
      position: relative;
      display: inline-block;
      width: 100%;
      cursor: pointer;
    }
    
    .mui-file-input input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .mui-file-input .file-input-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.1) 0%, rgba(144, 202, 249, 0.05) 100%);
      border: 2px dashed rgba(144, 202, 249, 0.3);
      border-radius: 8px;
      color: rgba(144, 202, 249, 0.9);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-height: 48px;
    }
    
    .mui-file-input:hover .file-input-button {
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.15) 0%, rgba(144, 202, 249, 0.08) 100%);
      border-color: rgba(144, 202, 249, 0.5);
      transform: translateY(-1px);
    }
    
    .mui-file-input.has-files .file-input-button {
      background: linear-gradient(135deg, rgba(144, 202, 249, 0.2) 0%, rgba(144, 202, 249, 0.1) 100%);
      border-color: rgba(144, 202, 249, 0.6);
      border-style: solid;
    }

    /* Custom Checkbox Styling */
    .mui-checkbox {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .mui-checkbox input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .mui-checkbox .checkbox-custom {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      background: rgba(144, 202, 249, 0.08);
      border: 2px solid rgba(144, 202, 249, 0.3);
      border-radius: 4px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mui-checkbox:hover .checkbox-custom {
      background: rgba(144, 202, 249, 0.12);
      border-color: rgba(144, 202, 249, 0.5);
    }
    
    .mui-checkbox input[type="checkbox"]:checked + .checkbox-custom {
      background: linear-gradient(135deg, #90caf9 0%, #42a5f5 100%);
      border-color: #90caf9;
    }
    
    .mui-checkbox input[type="checkbox"]:checked + .checkbox-custom::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 10px;
      border: solid #000;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      top: 1px;
      left: 6px;
    }
    
    .mui-checkbox input[type="checkbox"]:focus + .checkbox-custom {
      box-shadow: 0 0 0 3px rgba(144, 202, 249, 0.2);
    }
    .mui-btn-danger { background: #dc2626; color: #fff; border: 1px solid #dc2626; }
    .mui-btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }
    .mui-chip { display: inline-flex; padding: 0 12px; height: 24px; align-items: center; border-radius: 12px; font-size: 0.75rem; text-transform: capitalize; }
    .mui-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(144, 202, 249, 0.3); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Row selection styling */
    .torrent-row {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .torrent-row:hover {
      background-color: rgba(144, 202, 249, 0.05) !important;
    }
    .torrent-row.selected-row {
      background-color: rgba(144, 202, 249, 0.15) !important;
      border-left: 4px solid #90caf9 !important;
    }
    .torrent-row.selected-row:hover {
    /* Enhanced bulk actions card styling */
    .bulk-actions-card {
      background: linear-gradient(135deg, 
        rgba(144, 202, 249, 0.15) 0%, 
        rgba(66, 165, 245, 0.1) 30%, 
        rgba(144, 202, 249, 0.08) 70%, 
        rgba(25, 118, 210, 0.06) 100%) !important;
      border: 1px solid rgba(144, 202, 249, 0.25) !important;
      box-shadow: 
        0 8px 32px rgba(144, 202, 249, 0.15), 
        inset 0 1px 0 rgba(255, 255, 255, 0.15), 
        inset 0 -1px 0 rgba(144, 202, 249, 0.1) !important;
      backdrop-filter: blur(12px) !important;
      position: relative;
      overflow: hidden;
    }
    .bulk-actions-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(144, 202, 249, 0.6), transparent);
      animation: shimmer 3s infinite;
    }
    .bulk-actions-card .selection-text {
      color: rgba(144, 202, 249, 0.95) !important;
      font-weight: 600 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }
    .bulk-actions-card .mui-btn {
      backdrop-filter: blur(4px) !important;
      transition: all 0.3s ease !important;
    }
    .bulk-actions-card .mui-btn:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(144, 202, 249, 0.2) !important;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }
      background-color: rgba(144, 202, 249, 0.2) !important;
    }
    /* Mobile button consistency */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn { padding: 12px 20px !important; font-size: 0.875rem !important; }
      nav {
        width: 100%;
        justify-content: center;
      }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
  </style>
</head>
<body class="gradient-bg-dark text-text-primary">
  <div x-data="torrentsApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-gray-900/90 backdrop-blur border-b border-white/10">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4">
          <h1 class="text-lg sm:text-xl font-bold">@Torrent</h1>
          <nav class="flex flex-wrap justify-center sm:justify-start gap-1 sm:gap-2">
            <a href="/dashboard.html" class="mui-nav-link">Dashboard</a>
            <a href="/torrents.html" class="mui-nav-link active">Torrents</a>
            <a href="/statistics.html" class="mui-nav-link">Statistics</a>
            <a href="/settings.html" class="mui-nav-link">Settings</a>
            <button @click="logout()" class="mui-btn mui-btn-danger sm:ml-4">Logout</button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold mb-2">Torrents</h2>
          <p class="text-text-secondary">Manage all your torrents in one place</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="main-add-btn" @click="showAddDialog = true" class="mui-btn mui-btn-contained whitespace-nowrap" style="color: #000 !important; padding: 12px 24px !important; border-radius: 8px !important; font-weight: 500 !important; white-space: nowrap !important; border: none !important; transition: all 0.2s ease !important;">
            + Add Torrent(s)
          </button>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="mui-card p-4 mb-6">
        <div class="flex gap-4 flex-wrap">
          <input type="text" x-model="searchQuery" @input="filterTorrents()" 
                 placeholder="Search torrents..." class="mui-input flex-1 min-w-[200px]">
          
          <div class="relative inline-block">
            <select id="status-filter" x-model="statusFilter" @change="filterTorrents()" class="bg-gray-700 border border-blue-400 rounded text-blue-300 px-3 py-2 text-sm focus:outline-none focus:ring-0 focus:border-blue-500 hover:bg-gray-600 appearance-none cursor-pointer pr-8">
              <option value="">All Status</option>
              <option value="downloading">Downloading</option>
              <option value="seeding">Seeding</option>
              <option value="paused">Paused</option>
              <option value="checking">Checking</option>
              <option value="error">Error</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
              <span class="text-blue-400 text-sm">▼</span>
            </div>
          </div>
          
          <div class="relative inline-block">
            <select id="sort-filter" x-model="sortBy" @change="sortTorrents()" class="bg-gray-700 border border-blue-400 rounded text-blue-300 px-3 py-2 text-sm focus:outline-none focus:ring-0 focus:border-blue-500 hover:bg-gray-600 appearance-none cursor-pointer pr-8">
              <option value="name">Sort by Name</option>
              <option value="size">Sort by Size</option>
              <option value="progress">Sort by Progress</option>
              <option value="speed">Sort by Speed</option>
              <option value="added">Sort by Date Added</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
              <span class="text-blue-400 text-sm">▼</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div x-show="selectedTorrents.length > 0" class="mui-card bulk-actions-card p-4 mb-4" >
        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4">
          <span class="selection-text"><span x-text="selectedTorrents.length"></span> torrent(s) selected</span>
          <div class="flex flex-wrap gap-2">
            <button @click="bulkAction('pause')" 
                    :disabled="!canPauseSelected"
                    :class="canPauseSelected ? '' : 'opacity-50 cursor-not-allowed'"
                    class="mui-btn mui-btn-outlined">Pause Selected</button>
            <button @click="bulkAction('resume')" 
                    :disabled="!canResumeSelected"
                    :class="canResumeSelected ? '' : 'opacity-50 cursor-not-allowed'"
                    class="mui-btn mui-btn-outlined">Resume Selected</button>
            <button @click="bulkAction('delete')" class="mui-btn mui-btn-danger">Delete Selected</button>
            <button @click="selectedTorrents = []" class="mui-btn mui-btn-outlined">Clear Selection</button>
          </div>
        </div>
      </div>

      <!-- Torrents Table -->
      <div class="mui-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full resizable-table" x-data="{ resizing: false }">
            <thead class="bg-background-elevated border-b border-white/10">
              <tr>
                <th class="p-4 text-left fit-content" style="width: 50px;">
                  <input type="checkbox" @change="toggleSelectAll($event)" 
                         :checked="selectedTorrents.length > 0 && selectedTorrents.length === filteredTorrents.length"
                         class="rounded border-gray-600">
                  
                </th>
                <th class="p-4 pl-6 text-left fit-content no-truncate" style="width: 90px;">
                  Actions
                  
                </th>
                <th class="p-4 text-left" style="width: 50%;">
                  Name
                  
                </th>
                <th class="p-4 text-left" style="width: 100px;">
                  Size
                  
                </th>
                <th class="p-4 text-left" style="width: 120px;">
                  Progress
                  
                </th>
                <th class="p-4 text-left fit-content no-truncate" style="width: 130px;">
                  Status
                  
                </th>
                <th class="p-4 text-left fit-content no-truncate" style="width: 200px;">
                  Download/Upload
                  
                </th>
                <th class="p-4 text-left fit-content no-truncate" style="width: 120px;">
                  Seeds/Peers
                  
                </th>
                <th class="p-4 text-left fit-content" style="width: 100px;">
                  ETA
                </th>
              </tr>
            </thead>
            <tbody>
              <template x-if="loading">
                <tr>
                  <td colspan="9" class="text-center py-8">
                    <div class="mui-spinner"></div>
                  </td>
                </tr>
              </template>
              
              <template x-if="!loading && filteredTorrents.length === 0">
                <tr>
                  <td colspan="9" class="text-center py-8 text-text-secondary">
                    No torrents found
                  </td>
                </tr>
              </template>
              
              <template x-for="torrent in filteredTorrents" :key="torrent.id">
                <tr class="border-b border-white/5 torrent-row" :class="{'selected-row': selectedTorrents.includes(torrent.id)}" @click="toggleSelect(torrent.id)">
                  <td class="p-4">
                    <input type="checkbox" :value="torrent.id" 
                           @change="toggleSelect(torrent.id)" @click.stop
                           :checked="selectedTorrents.includes(torrent.id)"
                           class="rounded border-gray-600">
                  </td>
                  <td class="p-4">
                    <div class="flex flex-wrap gap-1">
                      <button @click.stop="toggleTorrent(torrent)" 
                              class="p-1 hover:bg-white/10 rounded" title="Play/Pause">
                        <svg x-show="torrent.status !== 'paused'" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                        <svg x-show="torrent.status === 'paused'" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M8 5v14l11-7z"/>
                        </svg>
                      </button>
                      <button @click.stop="deleteTorrent(torrent.id)" 
                              class="p-1 hover:bg-white/10 rounded text-error-main" title="Delete">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                  <td class="p-4 pl-6" style="min-width: 150px; width: auto;">
                    <div @click.stop="showDetails(torrent)" class="cursor-pointer hover:text-primary-main" style="overflow: hidden;">
                      <div class="font-medium truncate" x-text="torrent.name" :title="torrent.name"></div>
                      <div class="text-xs text-text-secondary mt-1 truncate" x-text="torrent.info_hash ? torrent.info_hash.substring(0, 20) + '...' : ''"></div>
                    </div>
                  </td>
                  <td class="p-4 text-xs" x-text="formatBytes(torrent.total_size)"></td>
                  <td class="p-4">
                    <div class="relative w-full">
                      <div class="w-full h-7 bg-gray-800/50 rounded-lg border border-white/10 overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-300 relative" 
                             :style="`width: ${torrent.progress * 100}%`">
                          <div class="absolute inset-0 progress-shimmer" x-show="torrent.status === 'downloading'"></div>
                        </div>
                      </div>
                      <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xs font-semibold text-white drop-shadow-md" x-text="Math.round(torrent.progress * 100) + '%'"></span>
                      </div>
                    </div>
                  </td>
                  <td class="p-4 no-truncate">
                    <span class="mui-chip" 
                          :class="{
                            'bg-primary-main/20 text-primary-main': torrent.status === 'downloading',
                            'bg-success-main/20 text-success-main': torrent.status === 'seeding',
                            'bg-warning-main/20 text-warning-main': torrent.status === 'checking',
                            'bg-error-main/20 text-error-main': torrent.status === 'error',
                            'bg-white/10': torrent.status === 'paused'
                          }"
                          x-text="torrent.status"></span>
                  </td>
                  <td class="p-4 text-xs whitespace-nowrap no-truncate">
                    <span class="text-primary-main" x-text="formatSpeed(torrent.download_speed || 0)"></span>
                    <span class="text-text-secondary mx-1">/</span>
                    <span class="text-success-main" x-text="formatSpeed(torrent.upload_speed || 0)"></span>
                  </td>
                  <td class="p-4 text-xs">
                    <span x-text="torrent.num_seeds"></span>/<span x-text="torrent.num_peers"></span>
                  </td>
                  <td class="p-4 text-xs whitespace-nowrap">
                    <span x-text="torrent.eta ? formatTime(torrent.eta) : '-'"></span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-text-secondary text-xs">
      <p>Copyright © 2025. All rights reserved.</p>
    </footer>

    <!-- Add Torrent Dialog -->
    <div x-show="showAddDialog" x-cloak class="fixed inset-0 bg-black/75 flex items-center justify-center z-50" 
         @click.self="showAddDialog = false">
      <div class="mui-card backdrop-blur rounded-xl p-6 w-full max-w-lg">
        <h3 class="text-lg font-bold mb-4">Add Torrents</h3>
        
        <!-- File Upload Area -->
        <div class="mb-4">
          <label class="block text-xs font-medium mb-2">Select Torrent Files</label>
          <div class="mui-file-input" :class="{'has-files': selectedFiles.length > 0}" @click="$refs.fileInput.click()">
            <input type="file" @change="handleFileSelect($event)" accept=".torrent" multiple x-ref="fileInput">
            <div class="file-input-button">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
              <span x-show="selectedFiles.length === 0">Choose torrent files</span>
              <span x-show="selectedFiles.length > 0" x-text="selectedFiles.length + ' file(s) selected'"></span>
            </div>
          </div>
          <div x-show="selectedFiles.length > 0" class="mt-2 text-xs text-text-secondary">
            Selected: <span x-text="selectedFiles.length + ' file(s)'"></span>
          </div>
        </div>
        
        <!-- Auto-start option -->
        <div class="mb-4">
          <label class="flex items-center gap-3 cursor-pointer">
            <div class="mui-checkbox">
              <input type="checkbox" x-model="autoStartDownloads">
              <div class="checkbox-custom"></div>
            </div>
            <span class="text-sm">Start downloads automatically</span>
          </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-2 justify-end">
          <button @click="showAddDialog = false; resetAddForm()" class="mui-btn mui-btn-outlined">Cancel</button>
          <button @click="addTorrents()" class="mui-btn mui-btn-contained" :disabled="selectedFiles.length === 0">
            Add <span x-show="selectedFiles.length > 0" x-text="'(' + selectedFiles.length + ')'" ></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Torrent Details Dialog -->
    <div x-show="showDetailsDialog" x-cloak class="fixed inset-0 bg-black/75 flex items-center justify-center z-50" 
         @click.self="showDetailsDialog = false">
      <div class="mui-card backdrop-blur rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-4" x-text="selectedTorrent?.name"></h3>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-text-secondary text-xs">Status</label>
            <p class="font-medium" x-text="selectedTorrent?.status"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Progress</label>
            <p class="font-medium" x-text="Math.round((selectedTorrent?.progress || 0) * 100) + '%'"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Size</label>
            <p class="font-medium" x-text="formatBytes(selectedTorrent?.total_size || 0)"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Downloaded</label>
            <p class="font-medium" x-text="formatBytes(selectedTorrent?.downloaded || 0)"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Uploaded</label>
            <p class="font-medium" x-text="formatBytes(selectedTorrent?.uploaded || 0)"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Ratio</label>
            <p class="font-medium" x-text="(selectedTorrent?.ratio || 0).toFixed(2)"></p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Seeds</label>
            <p class="font-medium"><span x-text="selectedTorrent?.num_seeds"></span> (<span x-text="selectedTorrent?.total_seeds"></span> total)</p>
          </div>
          <div>
            <label class="text-text-secondary text-xs">Peers</label>
            <p class="font-medium"><span x-text="selectedTorrent?.num_peers"></span> (<span x-text="selectedTorrent?.total_peers"></span> total)</p>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-text-secondary text-xs">Info Hash</label>
          <p class="font-mono text-xs break-all" x-text="selectedTorrent?.info_hash"></p>
        </div>

        <div class="mb-4">
          <label class="text-text-secondary text-xs">Save Path</label>
          <p class="text-xs" x-text="selectedTorrent?.save_path || 'Default'"></p>
        </div>

        <div class="flex gap-2 justify-end">
          <button @click="showDetailsDialog = false" class="mui-btn mui-btn-outlined">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE = 'http://192.168.50.2:8000/api/v1';
    
    // Utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatSpeed(bytesPerSecond) {
      return formatBytes(bytesPerSecond) + '/s';
    }
    
    function formatTime(seconds) {
      if (!seconds || seconds === Infinity) return '∞';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return h > 0 ? `${h}h ${m}m` : m > 0 ? `${m}m ${s}s` : `${s}s`;
    }
    
    // Alpine.js App
    function torrentsApp() {
      return {
        torrents: [],
        filteredTorrents: [],
        selectedTorrents: [],
        loading: false,
        showAddDialog: false,
        showDetailsDialog: false,
        selectedTorrent: null,
        searchQuery: '',
        statusFilter: '',
        sortBy: 'name',
        selectedFiles: [],
        autoStartDownloads: true,
        
        // Computed properties for selected torrents button states
        get canPauseSelected() {
          const selectedTorrentObjs = this.torrents.filter(t => this.selectedTorrents.includes(t.id));
          return selectedTorrentObjs.some(t => t.status !== 'paused');
        },
        
        get canResumeSelected() {
          const selectedTorrentObjs = this.torrents.filter(t => this.selectedTorrents.includes(t.id));
          return selectedTorrentObjs.some(t => t.status === 'paused');
        },
        
        async init() {
          const token = getCookie('access_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }
          
          // Initial fetch
          await this.fetchTorrents();
          
          // Setup WebSocket for real-time updates
          this.setupWebSocket();
        },
        
        setupWebSocket() {
          // Store reference to Alpine component
          const alpineComponent = this;
          
          try {
            // Create update handler that uses the stored component reference
            const updateHandler = function(data) {
              // Update torrents data in real-time
              if (data && Array.isArray(data)) {
                // Update using the stored Alpine component reference
                alpineComponent.torrents = [...data];
                alpineComponent.filterTorrents();
              }
            };
            
            // Remove any existing listener before adding new one
            window.torrentWS.off('torrent_update', this.updateHandler);
            this.updateHandler = updateHandler;
            window.torrentWS.on('torrent_update', updateHandler);
            
            // Handle connection status
            const connectedHandler = () => {
              this.fetchTorrents();
            };
            
            const disconnectedHandler = () => {
              // Handle disconnection silently
            };
            
            window.torrentWS.off('connected', this.connectedHandler);
            window.torrentWS.off('disconnected', this.disconnectedHandler);
            this.connectedHandler = connectedHandler;
            this.disconnectedHandler = disconnectedHandler;
            window.torrentWS.on('connected', connectedHandler);
            window.torrentWS.on('disconnected', disconnectedHandler);
            
            // Connect if not already connected
            window.torrentWS.connect();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async fetchTorrents() {
          const token = getCookie('access_token');
          
          try {
            const response = await fetch(`${API_BASE}/torrents/`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
              this.torrents = await response.json();
              this.filterTorrents();
            }
          } catch (error) {
            // Handle error silently
          }
        },
        
        filterTorrents() {
          let filtered = [...this.torrents];
          
          // Search filter
          if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            filtered = filtered.filter(t => 
              t.name.toLowerCase().includes(query) ||
              t.hash?.toLowerCase().includes(query)
            );
          }
          
          // Status filter
          if (this.statusFilter) {
            filtered = filtered.filter(t => t.status === this.statusFilter);
          }
          
          this.filteredTorrents = filtered;
          this.sortTorrents();
        },
        
        sortTorrents() {
          this.filteredTorrents.sort((a, b) => {
            switch (this.sortBy) {
              case 'size':
                return b.total_size - a.total_size;
              case 'progress':
                return b.progress - a.progress;
              case 'speed':
                return (b.download_speed + b.upload_speed) - (a.download_speed + a.upload_speed);
              case 'added':
                return new Date(b.added_time) - new Date(a.added_time);
              default:
                return a.name.localeCompare(b.name);
            }
          });
        },
        
        toggleSelect(id) {
          const index = this.selectedTorrents.indexOf(id);
          if (index > -1) {
            this.selectedTorrents.splice(index, 1);
          } else {
            this.selectedTorrents.push(id);
          }
        },
        
        toggleSelectAll(event) {
          if (event.target.checked) {
            this.selectedTorrents = this.filteredTorrents.map(t => t.id);
          } else {
            this.selectedTorrents = [];
          }
        },
        
        async toggleTorrent(torrent) {
          const token = getCookie('access_token');
          const action = torrent.status === 'paused' ? 'resume' : 'pause';
          
          try {
            await fetch(`${API_BASE}/torrents/${torrent.id}/${action}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            await this.fetchTorrents();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async deleteTorrent(id) {
          if (!confirm('Delete this torrent and its files?')) return;
          
          const token = getCookie('access_token');
          try {
            await fetch(`${API_BASE}/torrents/${id}?delete_files=true`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            await this.fetchTorrents();
          } catch (error) {
            // Handle error silently
          }
        },
        
        async bulkAction(action) {
          if (this.selectedTorrents.length === 0) return;
          
          const token = getCookie('access_token');
          
          if (action === 'delete') {
            if (!confirm(`Delete ${this.selectedTorrents.length} torrent(s) and their files?`)) return;
            
            try {
              await fetch(`${API_BASE}/torrents/bulk?delete_files=true`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  torrent_ids: this.selectedTorrents
                })
              });
            } catch (error) {
            // Handle error silently
            }
          } else {
            try {
              await fetch(`${API_BASE}/torrents/bulk/${action}`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ torrent_ids: this.selectedTorrents })
              });
            } catch (error) {
              // Handle error silently
            }
          }
          
          this.selectedTorrents = [];
          await this.fetchTorrents();
        },
        
        async addTorrents() {
          const token = getCookie('access_token');
          
          if (this.selectedFiles.length === 0) {
            alert('Please select torrent files');
            return;
          }
          
          try {
            // Add each torrent file
            for (const fileData of this.selectedFiles) {
              await fetch(`${API_BASE}/torrents/`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  torrent_file: fileData.content,
                  auto_start: this.autoStartDownloads
                })
              });
            }
            
            this.showAddDialog = false;
            this.resetAddForm();
            await this.fetchTorrents();
          } catch (error) {
            alert('Failed to add torrents');
          }
        },
        
        handleFileSelect(event) {
          this.selectedFiles = [];
          const files = event.target.files;
          
          if (files.length > 0) {
            let filesProcessed = 0;
            
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const reader = new FileReader();
              
              reader.onload = (e) => {
                this.selectedFiles.push({
                  name: file.name,
                  content: btoa(e.target.result)
                });
                
                filesProcessed++;
                if (filesProcessed === files.length) {
                  // All files processed
                  
                }
              };
              
              reader.readAsBinaryString(file);
            }
          }
        },
        
        resetAddForm() {
          this.selectedFiles = [];
        },
        
        showDetails(torrent) {
          this.selectedTorrent = torrent;
          this.showDetailsDialog = true;
        },
        
        startResize(event, columnIndex) {
          event.preventDefault();
          const table = event.target.closest('table');
          const th = event.target.closest('th');
          const startX = event.clientX;
          const startWidth = th.offsetWidth;
          
          // Calculate dynamic minimum for Name column
          const tableWidth = table.offsetWidth;
          const nameColumnMinWidth = Math.max(150, tableWidth * 0.1); // 10% of table or 150px minimum
          
          // Define minimum widths for specific columns
          const columnMinWidths = {
            0: 50,   // Checkbox column
            1: 90,   // Actions column
            2: nameColumnMinWidth,  // Name column - MUST be visible (10% minimum)
            3: 80,   // Size column
            4: 120,  // Progress column
            5: 130,  // Status column - wider with more spacing
            6: 200,  // Download/Upload column - wider with more spacing
            7: 120,  // Seeds/Peers column - wider with more spacing
            8: 100   // ETA column - wider with more spacing
          };
          
          const minWidth = columnMinWidths[columnIndex] || 80;
          
          // Add visual feedback
          event.target.classList.add('column-resizing');
          document.body.style.cursor = 'col-resize';
          
          const onMouseMove = (e) => {
            const diff = e.clientX - startX;
            const newWidth = Math.max(minWidth, startWidth + diff);
            th.style.width = newWidth + 'px';
            
            // Also update the corresponding td elements for Name column
            if (columnIndex === 2) {
              const tds = table.querySelectorAll('tbody td:nth-child(3)');
              tds.forEach(td => {
                td.style.width = newWidth + 'px';
                td.style.minWidth = minWidth + 'px';
              });
            }
          };
          
          const onMouseUp = () => {
            // Remove visual feedback
            event.target.classList.remove('column-resizing');
            document.body.style.cursor = '';
            
            // Ensure Name column maintains minimum width after resize
            if (columnIndex === 2) {
              const finalWidth = th.offsetWidth;
              if (finalWidth < minWidth) {
                th.style.width = minWidth + 'px';
                const tds = table.querySelectorAll('tbody td:nth-child(3)');
                tds.forEach(td => {
                  td.style.width = minWidth + 'px';
                  td.style.minWidth = minWidth + 'px';
                });
              }
            }
            
            // Remove event listeners
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          };
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        },
        
        logout() {
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/login.html';
        }
      };
    }
  </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to enforce minimum width for Name column
        function enforceNameColumnWidth() {
        const table = document.querySelector('.resizable-table');
        if (!table) return;
        
        // Get all Name column cells (3rd column)
        const nameHeaders = table.querySelectorAll('thead th:nth-child(3)');
        const nameCells = table.querySelectorAll('tbody td:nth-child(3)');
        
        // Enforce minimum width
        [...nameHeaders, ...nameCells].forEach(cell => {
            const currentWidth = cell.offsetWidth;
            const tableWidth = table.offsetWidth;
            const minWidth = Math.max(150, tableWidth * 0.1); // 10% or 150px, whichever is larger
            
            if (currentWidth < minWidth) {
            cell.style.minWidth = minWidth + 'px';
            cell.style.width = minWidth + 'px';
            }
        });
        }
        
        // Run on load
        enforceNameColumnWidth();
        
        // Run on window resize
        window.addEventListener('resize', enforceNameColumnWidth);
        
        // Override any resize events on the table
        const resizers = document.querySelectorAll('.column-resizer');
        resizers.forEach((resizer, index) => {
        if (index === 2) { // Name column resizer
            resizer.addEventListener('mouseup', enforceNameColumnWidth);
        }
        });
    });
    </script>

</body>
</html>

