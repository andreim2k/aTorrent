<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistics - aTorrent</title>
  
  <!-- Alpine.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  
  <!-- WebSocket Client -->
  <script src="/js/websocket-client.js"></script>
  
  
  <!-- Tailwind CSS from CDN -->
  <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { main: '#90caf9', light: '#e3f2fd', dark: '#42a5f5' },
            secondary: { main: '#f48fb1', light: '#fce4ec', dark: '#ad1457' },
            success: { main: '#66bb6a', light: '#81c784', dark: '#388e3c' },
            warning: { main: '#ffa726', light: '#ffb74d', dark: '#f57c00' },
            error: { main: '#f44336', light: '#ef5350', dark: '#c62828' },
            background: { default: '#121212', paper: '#1e1e1e', elevated: '#272727' },
            text: { primary: '#ffffff', secondary: '#b3b3b3', disabled: '#666666' }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Responsive navigation fixes */
    @media (max-width: 640px) {
      nav {
        width: 100%;
        justify-content: center;
      }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mui-card { background: #1e1e1e; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .mui-btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .mui-btn-contained { background: #90caf9; color: #000; }
    .mui-btn-contained:hover { background: #42a5f5; }
    .mui-btn-outlined { background: transparent; color: #90caf9; border: 1px solid rgba(144, 202, 249, 0.5); }
    .mui-btn-outlined:hover { background: rgba(144, 202, 249, 0.1); }
    .mui-nav-link { padding: 8px 16px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    .mui-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(144, 202, 249, 0.3); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .stat-card { background: #1e1e1e; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  </style>
</head>
<body class="bg-background-default text-text-primary">
  <div x-data="statisticsApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-background-paper border-b border-white/10">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
          <h1 class="text-xl sm:text-2xl font-bold">aTorrent</h1>
          <nav class="flex gap-2">
            <a href="/dashboard.html" class="mui-nav-link">Dashboard</a>
            <a href="/torrents.html" class="mui-nav-link">Torrents</a>
            <a href="/statistics.html" class="mui-nav-link active">Statistics</a>
            <a href="/settings.html" class="mui-nav-link">Settings</a>
            <button @click="logout()" class="mui-btn mui-btn-outlined ml-2 sm:ml-4 text-sm sm:text-base">Logout</button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="mb-6">
        <h2 class="text-3xl font-bold mb-2">Statistics</h2>
        <p class="text-text-secondary">Monitor your torrent client performance and history</p>
      </div>

      <!-- Summary Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
          <div class="text-text-secondary text-sm mb-1">Total Downloaded</div>
          <div class="text-xl sm:text-2xl font-bold" x-text="formatBytes(stats.all_time_download || 0)"></div>
          <div class="text-xs text-success-main mt-2">↓ <span x-text="formatSpeed(stats.download_rate || 0)"></span></div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-sm mb-1">Total Uploaded</div>
          <div class="text-xl sm:text-2xl font-bold" x-text="formatBytes(stats.all_time_upload || 0)"></div>
          <div class="text-xs text-primary-main mt-2">↑ <span x-text="formatSpeed(stats.upload_rate || 0)"></span></div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-sm mb-1">Overall Ratio</div>
          <div class="text-xl sm:text-2xl font-bold" x-text="calculateRatio(stats.all_time_upload, stats.all_time_download)"></div>
          <div class="text-xs text-text-secondary mt-2">Share ratio</div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-sm mb-1">Active Time</div>
          <div class="text-xl sm:text-2xl font-bold" x-text="formatUptime(sessionStats.uptime || 0)"></div>
          <div class="text-xs text-text-secondary mt-2">Current session</div>
        </div>
      </div>


      <!-- Detailed Stats Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Session Statistics -->
        <div class="mui-card p-6">
          <h3 class="text-xl font-bold mb-4">Session Statistics</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-text-secondary">Active Torrents</span>
              <span class="font-medium" x-text="torrentStats.active_torrents || 0"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-secondary">Total Torrents</span>
              <span class="font-medium" x-text="torrentStats.total_torrents || 0"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-secondary">Connected Peers</span>
              <span class="font-medium" x-text="sessionStats.num_peers || 0"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-secondary">DHT Nodes</span>
              <span class="font-medium" x-text="sessionStats.dht_nodes || 0"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-secondary">Listen Port</span>
              <span class="font-medium" x-text="sessionStats.port || 'N/A'"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-text-secondary">Protocol Version</span>
              <span class="font-medium" x-text="sessionStats.libtorrent_version || 'N/A'"></span>
            </div>
          </div>
        </div>

        <!-- Top Torrents -->
        <div class="mui-card p-6">
          <h3 class="text-xl font-bold mb-4">Top Active Torrents</h3>
          <div class="space-y-3">
            <template x-for="torrent in topTorrents" :key="torrent.id">
              <div class="border-b border-white/10 pb-3 last:border-0">
                <div class="flex justify-between items-start">
                  <div class="flex-1 min-w-0 mr-3">
                    <div class="font-medium truncate" x-text="torrent.name"></div>
                    <div class="text-xs text-text-secondary mt-1">
                      <span x-text="formatBytes(torrent.total_size)"></span> • 
                      <span x-text="Math.round(torrent.progress * 100) + '%'"></span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-primary-main">↓ <span x-text="formatSpeed(torrent.download_speed)"></span></div>
                    <div class="text-xs text-success-main">↑ <span x-text="formatSpeed(torrent.upload_speed)"></span></div>
                  </div>
                </div>
              </div>
            </template>
            <div x-show="topTorrents.length === 0" class="text-center text-text-secondary py-4">
              No active torrents
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // API Configuration
    const API_BASE = 'http://192.168.50.2:8000/api/v1';
    
    // Utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatSpeed(bytesPerSecond) {
      return formatBytes(bytesPerSecond) + '/s';
    }
    
    function formatUptime(seconds) {
      if (!seconds) return '0s';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }
    
    // Alpine.js App
    function statisticsApp() {
      return {
        stats: {},
        sessionStats: {},
        torrentStats: {},
        topTorrents: [],
        lastTorrentData: new Map(), // Track previous torrent data for calculating deltas
        
        calculateRatio(upload, download) {
          if (!download || download === 0) return '∞';
          return (upload / download).toFixed(2);
        },
        
        formatBytes,
        formatSpeed,
        formatUptime,
        
        async init() {
          const token = getCookie('access_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }
          
          // Initial stats fetch
          await this.fetchStats();
          
          // Setup WebSocket for real-time updates
          this.setupWebSocket();
        },
        
        setupWebSocket() {
          // Connect to WebSocket
          window.torrentWS.connect();
          
          // Listen for torrent updates to calculate stats
          window.torrentWS.on('torrent_update', (torrents) => {
            // Update top torrents from real-time data
            this.topTorrents = torrents
              .filter(t => t.status === 'downloading' || t.status === 'seeding')
              .sort((a, b) => (b.download_speed + b.upload_speed) - (a.download_speed + a.upload_speed))
              .slice(0, 5);
            
            // Calculate current speeds and update all-time totals
            let downloadSpeed = 0;
            let uploadSpeed = 0;
            let allTimeDownloadDelta = 0;
            let allTimeUploadDelta = 0;
            
            torrents.forEach(t => {
              downloadSpeed += t.download_speed || 0;
              uploadSpeed += t.upload_speed || 0;
              
              // Calculate delta from last update for all-time totals
              const lastData = this.lastTorrentData.get(t.id);
              if (lastData) {
                // Calculate the change in downloaded/uploaded bytes
                const downloadedDelta = Math.max(0, (t.downloaded || 0) - (lastData.downloaded || 0));
                const uploadedDelta = Math.max(0, (t.uploaded || 0) - (lastData.uploaded || 0));
                
                allTimeDownloadDelta += downloadedDelta;
                allTimeUploadDelta += uploadedDelta;
              }
              
              // Store current data for next comparison
              this.lastTorrentData.set(t.id, {
                downloaded: t.downloaded || 0,
                uploaded: t.uploaded || 0
              });
            });
            
            // Update all-time totals by adding deltas
            if (allTimeDownloadDelta > 0 || allTimeUploadDelta > 0) {
              this.stats.all_time_download = (this.stats.all_time_download || 0) + allTimeDownloadDelta;
              this.stats.all_time_upload = (this.stats.all_time_upload || 0) + allTimeUploadDelta;
            }
            
            // Update current speeds
            this.stats.download_rate = downloadSpeed;
            this.stats.upload_rate = uploadSpeed;
          });
          
          // Refresh full stats periodically (less frequently) to correct any drift
          setInterval(() => this.fetchStats(), 60000); // Every 60 seconds
        },
        
        async fetchStats() {
          const token = getCookie('access_token');
          
          try {
            // Fetch various statistics
            const [statsRes, sessionRes, torrentsRes] = await Promise.all([
              fetch(`${API_BASE}/torrents/stats/overview`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }),
              fetch(`${API_BASE}/torrents/stats/session`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }),
              fetch(`${API_BASE}/torrents/`, {
                headers: { 'Authorization': `Bearer ${token}` }
              })
            ]);
            
            if (statsRes.ok) {
              this.torrentStats = await statsRes.json();
            }
            
            if (sessionRes.ok) {
              this.sessionStats = await sessionRes.json();
            }
            
            // Combine stats from both endpoints
            this.stats = {
              all_time_download: this.torrentStats.total_downloaded || 0,
              all_time_upload: this.torrentStats.total_uploaded || 0,
              download_rate: this.torrentStats.total_download_speed || 0,
              upload_rate: this.torrentStats.total_upload_speed || 0
            };
            
            if (torrentsRes.ok) {
              const torrents = await torrentsRes.json();
              
              // Initialize lastTorrentData with current values for delta tracking
              torrents.forEach(t => {
                this.lastTorrentData.set(t.id, {
                  downloaded: t.downloaded || 0,
                  uploaded: t.uploaded || 0
                });
              });
              
              // Get top 5 active torrents by speed
              this.topTorrents = torrents
                .filter(t => t.status === 'downloading' || t.status === 'seeding')
                .sort((a, b) => (b.download_speed + b.upload_speed) - (a.download_speed + a.upload_speed))
                .slice(0, 5);
            }
          } catch (error) {
            // Handle error silently
          }
        },
        
        logout() {
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/login.html';
        }
      };
    }
  </script>
</body>
</html>
