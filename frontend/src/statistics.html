<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistics - aTorrent</title>
  
  <!-- Alpine.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
  
  <!-- WebSocket Client -->
  <script src="/js/websocket-client.js"></script>
  
  
  <!-- Tailwind CSS from CDN -->
  <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { main: '#90caf9', light: '#e3f2fd', dark: '#42a5f5' },
            secondary: { main: '#f48fb1', light: '#fce4ec', dark: '#ad1457' },
            success: { main: '#66bb6a', light: '#81c784', dark: '#388e3c' },
            warning: { main: '#ffa726', light: '#ffb74d', dark: '#f57c00' },
            error: { main: '#f44336', light: '#ef5350', dark: '#c62828' },
            background: { default: '#121212', paper: '#1e1e1e', elevated: '#272727' },
            text: { primary: '#ffffff', secondary: '#b3b3b3', disabled: '#666666' }
          }
          }
        }
      }
  </script>
  
  <style>
    /* Beautiful gradient background */
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      min-height: 100vh;
      background-attachment: fixed;
    }
    .mui-nav-link { display: inline-flex; align-items: center; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    /* Global font size reduction - 20% smaller */
    .text-xs { font-size: 0.7rem !important; /* ~11px instead of 12px */ }
    body { font-size: 14px; /* reduced from default 16px */ }
    /* Responsive navigation fixes */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      nav {
        width: 100%;
        justify-content: center;
      }
      nav a, nav button {
        flex: 0 0 auto;
        min-width: fit-content;
      }
    }
    /* Minimal custom styles */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .mui-card { background: linear-gradient(135deg, rgba(20, 18, 35, 0.95) 0%, rgba(35, 30, 70, 0.9) 50%, rgba(25, 25, 45, 0.95) 100%); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37), 0 0 40px rgba(144, 202, 249, 0.1); border: 1px solid rgba(255, 255, 255, 0.08); }
    .mui-btn { padding: 12px 24px; font-size: 0.875rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .mui-btn-contained { background: #90caf9; color: #000; }
    .mui-btn-contained:hover { background: #42a5f5; }
    .mui-btn-outlined { background: transparent; color: #90caf9; border: 1px solid rgba(144, 202, 249, 0.5); }
    .mui-btn-danger { background: #dc2626; color: #fff; border: 1px solid #dc2626; }
    .mui-btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }
    .mui-btn-outlined:hover { background: rgba(144, 202, 249, 0.1); }
    .mui-chip { display: inline-flex; padding: 0 12px; height: 24px; align-items: center; border-radius: 12px; font-size: 0.75rem; text-transform: capitalize; }
    .mui-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(144, 202, 249, 0.3); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    .mui-nav-link { display: inline-flex; align-items: center; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
    .mui-nav-link:hover { background: rgba(255,255,255,0.1); }
    .mui-nav-link.active { background: rgba(144, 202, 249, 0.2); color: #90caf9; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Mobile button consistency */
    @media (max-width: 640px) {
      .mui-btn-danger { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-nav-link { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn-outlined { padding: 8px 12px !important; font-size: 0.875rem !important; }
      .mui-btn { padding: 12px 20px !important; font-size: 0.875rem !important; }
    }
    .stat-card { background: linear-gradient(135deg, rgba(20, 18, 35, 0.95) 0%, rgba(35, 30, 70, 0.9) 50%, rgba(25, 25, 45, 0.95) 100%); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37), 0 0 40px rgba(144, 202, 249, 0.1); border: 1px solid rgba(255, 255, 255, 0.08); }
    tbody tr:hover { background: linear-gradient(135deg, rgba(144, 202, 249, 0.1) 0%, rgba(144, 202, 249, 0.05) 100%); cursor: pointer; }
  </style>
</head>
<body class="gradient-bg-dark text-text-primary">
  <div x-data="statisticsApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-gray-900/90 backdrop-blur border-b border-white/10">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4">
          <h1 class="text-lg sm:text-xl font-bold">aTorrent</h1>
          <nav class="flex flex-wrap justify-center sm:justify-start gap-1 sm:gap-2">
            <a href="/dashboard.html" class="mui-nav-link">Dashboard</a>
            <a href="/torrents.html" class="mui-nav-link">Torrents</a>
            <a href="/statistics.html" class="mui-nav-link active">Statistics</a>
            <a href="/settings.html" class="mui-nav-link">Settings</a>
            <button @click="logout()" class="mui-btn mui-btn-danger sm:ml-4">Logout</button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Statistics</h2>
        <p class="text-text-secondary">Monitor your torrent client performance and history</p>
      </div>

      <!-- Summary Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
        <div class="stat-card">
          <div class="text-text-secondary text-xs mb-1">Total Downloaded</div>
          <div class="text-lg sm:text-xl font-bold" x-text="formatBytes(stats.all_time_download || 0)"></div>
          <div class="text-xs text-success-main mt-2">↓ <span x-text="formatSpeed(stats.download_rate || 0)"></span></div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-xs mb-1">Total Uploaded</div>
          <div class="text-lg sm:text-xl font-bold" x-text="formatBytes(stats.all_time_upload || 0)"></div>
          <div class="text-xs text-primary-main mt-2">↑ <span x-text="formatSpeed(stats.upload_rate || 0)"></span></div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-xs mb-1">Overall Ratio</div>
          <div class="text-lg sm:text-xl font-bold" x-text="calculateRatio(stats.all_time_upload, stats.all_time_download)"></div>
          <div class="text-xs text-text-secondary mt-2">Share ratio</div>
        </div>
        
        <div class="stat-card">
          <div class="text-text-secondary text-xs mb-1">Active Time</div>
          <div class="text-lg sm:text-xl font-bold" x-text="formatUptime(sessionStats.uptime || 0)"></div>
          <div class="text-xs text-text-secondary mt-2">Current session</div>
        </div>
      </div>



      <!-- System Statistics Card -->
      <div class="mb-8">
        <h3 class="text-xl font-bold mb-4 text-white">System Statistics</h3>
        <div class="mui-card p-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- CPU Stats -->
            <div class="space-y-4">
              <h4 class="text-lg font-semibold text-primary-main mb-3">CPU Usage</h4>
              
              <!-- Overall CPU -->
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-text-secondary">Overall</span>
                  <span class="text-sm font-medium text-white" id="cpu-usage-percent">0.0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div class="bg-primary-main h-2 rounded-full transition-all duration-300" 
                       id="cpu-usage-bar" style="width: 0%"></div>
                </div>
              </div>
              
              <!-- Per-core CPU -->
              <div class="space-y-2">
                <span class="text-sm text-text-secondary">Per Core</span>
                <div id="cpu-cores-container" class="space-y-1">
                  <!-- CPU cores will be populated dynamically -->
                </div>
              </div>
              
              <!-- CPU Info -->
              <div class="text-xs text-text-secondary space-y-1">
                <div>Cores: <span id="cpu-cores-count" class="text-white">0</span> logical, <span id="cpu-cores-physical" class="text-white">0</span> physical</div>
                <div>Frequency: <span id="cpu-frequency" class="text-white">0 MHz</span></div>
                <div>Load Average: <span id="cpu-load-avg" class="text-white">0.00, 0.00, 0.00</span></div>
              </div>
            </div>

            <!-- Memory Stats -->
            <div class="space-y-4">
              <h4 class="text-lg font-semibold text-primary-main mb-3">Memory Usage</h4>
              
              <!-- RAM Usage -->
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-text-secondary">RAM</span>
                  <span class="text-sm font-medium text-white" id="memory-usage-percent">0.0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div class="bg-success-main h-2 rounded-full transition-all duration-300" 
                       id="memory-usage-bar" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-text-secondary">
                  <span>Used: <span id="memory-used" class="text-white">0 GB</span></span>
                  <span>Total: <span id="memory-total" class="text-white">0 GB</span></span>
                </div>
              </div>
              
              <!-- Swap Usage -->
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-text-secondary">Swap</span>
                  <span class="text-sm font-medium text-white" id="swap-usage-percent">0.0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div class="bg-warning-main h-2 rounded-full transition-all duration-300" 
                       id="swap-usage-bar" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-text-secondary">
                  <span>Used: <span id="swap-used" class="text-white">0 GB</span></span>
                  <span>Total: <span id="swap-total" class="text-white">0 GB</span></span>
                </div>
              </div>
            </div>

            <!-- Disk Stats -->
            <div class="space-y-4">
              <h4 class="text-lg font-semibold text-primary-main mb-3">Disk Usage</h4>
              <div id="disk-partitions-container" class="space-y-3">
                <!-- Disk partitions will be populated dynamically -->
              </div>
              
              <!-- Disk I/O -->
              <div class="text-xs text-text-secondary space-y-1 pt-2 border-t border-gray-600">
                <div class="font-medium text-white mb-1">I/O Activity</div>
                <div>Read: <span id="disk-read-rate" class="text-white">0 MB/s</span></div>
                <div>Write: <span id="disk-write-rate" class="text-white">0 MB/s</span></div>
              </div>
            </div>

            <!-- Network Stats -->
            <div class="space-y-4">
              <h4 class="text-lg font-semibold text-primary-main mb-3">Network Activity</h4>
              
              <!-- Overall Network -->
              <div class="space-y-2">
                <div class="flex justify-between text-xs text-text-secondary">
                  <span>↓ Download Rate:</span>
                  <span id="network-download-rate" class="text-success-main font-medium">0 MB/s</span>
                </div>
                <div class="flex justify-between text-xs text-text-secondary">
                  <span>↑ Upload Rate:</span>
                  <span id="network-upload-rate" class="text-primary-main font-medium">0 MB/s</span>
                </div>
              </div>
              
              <!-- Total Transfer -->
              <div class="text-xs text-text-secondary space-y-1 pt-2 border-t border-gray-600">
                <div class="font-medium text-white mb-1">Total Transfer</div>
                <div>Downloaded: <span id="network-total-download" class="text-white">0 GB</span></div>
                <div>Uploaded: <span id="network-total-upload" class="text-white">0 GB</span></div>
              </div>
              
              <!-- Active Interfaces -->
              <div class="text-xs text-text-secondary space-y-1 pt-2 border-t border-gray-600">
                <div class="font-medium text-white mb-1">Active Interfaces</div>
                <div id="network-interfaces-container">
                  <!-- Network interfaces will be populated dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Stats Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Session Statistics -->
        <div class="mui-card p-6">
          <h3 class="text-lg font-bold mb-4">Session Statistics</h3>
          <div class="grid grid-cols-2 gap-6">
            <!-- Column 1: Active torrents, total torrents, connected peers -->
            <div class="space-y-3">
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">Active Torrents</span>
                <span class="font-medium text-lg" x-text="torrentStats.active_torrents || 0"></span>
              </div>
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">Total Torrents</span>
                <span class="font-medium text-lg" x-text="torrentStats.total_torrents || 0"></span>
              </div>
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">Connected Peers</span>
                <span class="font-medium text-lg" x-text="sessionStats.num_peers || 0"></span>
              </div>
            </div>
            
            <!-- Column 2: DHT nodes, listen port, protocol version -->
            <div class="space-y-3">
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">DHT Nodes</span>
                <span class="font-medium text-lg" x-text="sessionStats.dht_nodes || 0"></span>
              </div>
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">Listen Port</span>
                <span class="font-medium text-lg" x-text="sessionStats.port || 'N/A'"></span>
              </div>
              <div class="flex flex-col">
                <span class="text-text-secondary text-sm">Protocol Version</span>
                <span class="font-medium text-lg" x-text="sessionStats.libtorrent_version || 'N/A'"></span>
              </div>
            </div>
          </div></div>
          </div>
        </div>


    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-text-secondary text-xs">
      <p>Copyright © 2025. All rights reserved.</p>
    </footer>
  </div>

  <script>
    // API Configuration
    const API_BASE = 'http://192.168.50.2:8000/api/v1';
    
    // Utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatSpeed(bytesPerSecond) {
      return formatBytes(bytesPerSecond) + '/s';
    }
    
    function formatUptime(seconds) {
      if (!seconds) return '0s';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }
    
    // Alpine.js App
    function statisticsApp() {
      return {
        stats: {},
        sessionStats: {},
        torrentStats: {},
        lastTorrentData: new Map(), // Track previous torrent data for calculating deltas

        // === SYSTEM STATISTICS WEBSOCKET ===
        systemStatsWS: null,
        systemStats: { cpu: {}, memory: {}, disk: {}, network: {} },
        
        formatBytesSystem(bytes) {
          if (!bytes || bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          const decimals = (i >= 3) ? 3 : 2;  // More precision for GB/TB
          return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
        },
        
        formatBytesPerSecondSystem(bytes) {
          return this.formatBytesSystem(bytes) + '/s';
        },
        
        formatFrequency(mhz) {
          if (!mhz) return '0 MHz';
          if (mhz >= 1000) return (mhz / 1000).toFixed(2) + ' GHz';
          return mhz.toFixed(0) + ' MHz';
        },
        
        setupSystemStatsWebSocket() {
          const wsUrl = 'ws://192.168.50.2:8000/api/v1/system/ws';
          const connectSystemStats = () => {
            this.systemStatsWS = new WebSocket(wsUrl);
            this.systemStatsWS.onopen = () => console.log('System stats WebSocket connected');
            this.systemStatsWS.onmessage = (event) => {
              try {
                const message = JSON.parse(event.data);
                if (message.type === 'system_stats' && message.data) {
                  this.systemStats = message.data;
                  this.updateSystemStatsUI();
                }
              } catch (error) {
                console.error('Error parsing system stats message:', error);
              }
            };
            this.systemStatsWS.onerror = (error) => console.error('System stats WebSocket error:', error);
            this.systemStatsWS.onclose = () => {
              console.log('System stats WebSocket disconnected, reconnecting...');
              setTimeout(connectSystemStats, 3000);
            };
          };
          connectSystemStats();
        },
        
        updateSystemStatsUI() {
          this.updateCPUStats();
          this.updateMemoryStats();
          this.updateDiskStats();
          this.updateNetworkStats();
        },
        
        updateCPUStats() {
          const cpu = this.systemStats.cpu || {};
          const usage = cpu.usage || 0;
          
          const cpuUsageEl = document.getElementById('cpu-usage-percent');
          const cpuBarEl = document.getElementById('cpu-usage-bar');
          if (cpuUsageEl) cpuUsageEl.textContent = usage.toFixed(1) + '%';
          if (cpuBarEl) cpuBarEl.style.width = Math.min(usage, 100) + '%';
          
          // Per-core usage
          const coresContainer = document.getElementById('cpu-cores-container');
          if (coresContainer && cpu.per_core && cpu.per_core.length > 0) {
            coresContainer.innerHTML = cpu.per_core.map((coreUsage, index) => `
              <div class="flex items-center space-x-2">
                <span class="text-xs text-text-secondary w-12">Core ${index}</span>
                <div class="flex-1 bg-gray-700 rounded-full h-1">
                  <div class="bg-primary-light h-1 rounded-full transition-all duration-300" 
                       style="width: ${Math.min(coreUsage, 100)}%"></div>
                </div>
                <span class="text-xs text-white w-10 text-right">${coreUsage.toFixed(0)}%</span>
              </div>
            `).join('');
          }
          
          // CPU info
          const coresCountEl = document.getElementById('cpu-cores-count');
          const coresPhysicalEl = document.getElementById('cpu-cores-physical');
          const cpuFreqEl = document.getElementById('cpu-frequency');
          const loadAvgEl = document.getElementById('cpu-load-avg');
          
          if (coresCountEl) coresCountEl.textContent = cpu.cores || 0;
          if (coresPhysicalEl) coresPhysicalEl.textContent = cpu.cores_physical || 0;
          if (cpuFreqEl) cpuFreqEl.textContent = this.formatFrequency(cpu.frequency?.current || 0);
          if (loadAvgEl && cpu.load_average) {
            const loadAvg = `${cpu.load_average['1min']?.toFixed(2) || 0}, ${cpu.load_average['5min']?.toFixed(2) || 0}, ${cpu.load_average['15min']?.toFixed(2) || 0}`;
            loadAvgEl.textContent = loadAvg;
          }
        },
        
        updateMemoryStats() {
          const memory = this.systemStats.memory || {};
          
          // RAM usage
          const ramPercent = memory.percent || 0;
          const memUsagePercentEl = document.getElementById('memory-usage-percent');
          const memUsageBarEl = document.getElementById('memory-usage-bar');
          const memUsedEl = document.getElementById('memory-used');
          const memTotalEl = document.getElementById('memory-total');
          
          if (memUsagePercentEl) memUsagePercentEl.textContent = ramPercent.toFixed(1) + '%';
          if (memUsageBarEl) memUsageBarEl.style.width = Math.min(ramPercent, 100) + '%';
          if (memUsedEl) memUsedEl.textContent = this.formatBytesSystem(memory.used || 0);
          if (memTotalEl) memTotalEl.textContent = this.formatBytesSystem(memory.total || 0);
          
          // Swap usage
          const swap = memory.swap || {};
          const swapPercent = swap.percent || 0;
          const swapUsagePercentEl = document.getElementById('swap-usage-percent');
          const swapUsageBarEl = document.getElementById('swap-usage-bar');
          const swapUsedEl = document.getElementById('swap-used');
          const swapTotalEl = document.getElementById('swap-total');
          
          if (swapUsagePercentEl) swapUsagePercentEl.textContent = swapPercent.toFixed(1) + '%';
          if (swapUsageBarEl) swapUsageBarEl.style.width = Math.min(swapPercent, 100) + '%';
          if (swapUsedEl) swapUsedEl.textContent = this.formatBytesSystem(swap.used || 0);
          if (swapTotalEl) swapTotalEl.textContent = this.formatBytesSystem(swap.total || 0);
        },
        
        updateDiskStats() {
          const disk = this.systemStats.disk || {};
          const partitions = disk.partitions || [];
          
          const partitionsContainer = document.getElementById('disk-partitions-container');
          if (partitionsContainer && partitions.length > 0) {
            partitionsContainer.innerHTML = partitions.slice(0, 3).map(partition => `
              <div class="space-y-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-text-secondary">${partition.device} (${partition.mountpoint})</span>
                  <span class="text-sm font-medium text-white">${partition.percent.toFixed(1)}%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-1">
                  <div class="bg-warning-main h-1 rounded-full transition-all duration-300" 
                       style="width: ${Math.min(partition.percent, 100)}%"></div>
                </div>
                <div class="flex justify-between text-xs text-text-secondary">
                  <span>Used: ${this.formatBytesSystem(partition.used)}</span>
                  <span>Free: ${this.formatBytesSystem(partition.free)}</span>
                </div>
              </div>
            `).join('');
          }
          
          // Disk I/O rates
          const io = disk.io || {};
          const diskReadRateEl = document.getElementById('disk-read-rate');
          const diskWriteRateEl = document.getElementById('disk-write-rate');
          if (diskReadRateEl) diskReadRateEl.textContent = this.formatBytesPerSecondSystem(io.read_rate || 0);
          if (diskWriteRateEl) diskWriteRateEl.textContent = this.formatBytesPerSecondSystem(io.write_rate || 0);
        },
        
        updateNetworkStats() {
          const network = this.systemStats.network || {};
          
          // Network rates
          const netDownloadRateEl = document.getElementById('network-download-rate');
          const netUploadRateEl = document.getElementById('network-upload-rate');
          if (netDownloadRateEl) netDownloadRateEl.textContent = this.formatBytesPerSecondSystem(network.bytes_recv_rate || 0);
          if (netUploadRateEl) netUploadRateEl.textContent = this.formatBytesPerSecondSystem(network.bytes_sent_rate || 0);
          
          // Total transfer
          const netTotalDownloadEl = document.getElementById('network-total-download');
          const netTotalUploadEl = document.getElementById('network-total-upload');
          if (netTotalDownloadEl) netTotalDownloadEl.textContent = this.formatBytesSystem(network.bytes_recv || 0);
          if (netTotalUploadEl) netTotalUploadEl.textContent = this.formatBytesSystem(network.bytes_sent || 0);
          
          // Active interfaces
          const interfaces = network.interfaces || [];
          const interfacesContainer = document.getElementById('network-interfaces-container');
          if (interfacesContainer) {
            const activeInterfaces = interfaces.filter(iface => iface.is_up && !iface.name.startsWith('lo'));
            if (activeInterfaces.length > 0) {
              interfacesContainer.innerHTML = activeInterfaces.slice(0, 3).map(iface => `
                <div class="text-xs">
                  <span class="text-white font-medium">${iface.name}</span>: 
                  <span class="text-success-main">↓${this.formatBytesSystem(iface.bytes_recv)}</span> 
                  <span class="text-primary-main">↑${this.formatBytesSystem(iface.bytes_sent)}</span>
                </div>
              `).join('');
            } else {
              interfacesContainer.innerHTML = '<div class="text-xs text-text-secondary">No active interfaces</div>';
            }
          }
        },
        
        calculateRatio(upload, download) {
          if (!download || download === 0) return '∞';
          return (upload / download).toFixed(2);
        },
        
        formatBytes,
        formatSpeed,
        formatUptime,
        
        async init() {
          const token = getCookie('access_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }
          
          // Initial stats fetch
          await this.fetchStats();
          
          // Setup WebSocket for real-time updates
          this.setupWebSocket();

          // Setup System Stats WebSocket
          this.setupSystemStatsWebSocket();
        },
        
        setupWebSocket() {
          // Connect to WebSocket
          window.torrentWS.connect();
          
          // Listen for torrent updates to calculate stats
          window.torrentWS.on('torrent_update', (torrents) => {
            
            // Calculate current speeds and update all-time totals
            let downloadSpeed = 0;
            let uploadSpeed = 0;
            let allTimeDownloadDelta = 0;
            let allTimeUploadDelta = 0;
            
            torrents.forEach(t => {
              downloadSpeed += t.download_speed || 0;
              uploadSpeed += t.upload_speed || 0;
              
              // Calculate delta from last update for all-time totals
              const lastData = this.lastTorrentData.get(t.id);
              if (lastData) {
                // Calculate the change in downloaded/uploaded bytes
                const downloadedDelta = Math.max(0, (t.downloaded || 0) - (lastData.downloaded || 0));
                const uploadedDelta = Math.max(0, (t.uploaded || 0) - (lastData.uploaded || 0));
                
                allTimeDownloadDelta += downloadedDelta;
                allTimeUploadDelta += uploadedDelta;
              }
              
              // Store current data for next comparison
              this.lastTorrentData.set(t.id, {
                downloaded: t.downloaded || 0,
                uploaded: t.uploaded || 0
              });
            });
            
            // Update all-time totals by adding deltas
            if (allTimeDownloadDelta > 0 || allTimeUploadDelta > 0) {
              this.stats.all_time_download = (this.stats.all_time_download || 0) + allTimeDownloadDelta;
              this.stats.all_time_upload = (this.stats.all_time_upload || 0) + allTimeUploadDelta;
            }
            
            // Update current speeds
            this.stats.download_rate = downloadSpeed;
            this.stats.upload_rate = uploadSpeed;
          });
          
          // Refresh full stats periodically (less frequently) to correct any drift
          setInterval(() => this.fetchStats(), 60000); // Every 60 seconds
        },
        
        async fetchStats() {
          const token = getCookie('access_token');
          
          try {
            // Fetch various statistics
            const [statsRes, sessionRes, torrentsRes] = await Promise.all([
              fetch(`${API_BASE}/torrents/stats/overview`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }),
              fetch(`${API_BASE}/torrents/stats/session`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }),
              fetch(`${API_BASE}/torrents/`, {
                headers: { 'Authorization': `Bearer ${token}` }
              })
            ]);
            
            if (statsRes.ok) {
              this.torrentStats = await statsRes.json();
            }
            
            if (sessionRes.ok) {
              this.sessionStats = await sessionRes.json();
            }
            
            // Combine stats from both endpoints
            this.stats = {
              all_time_download: this.torrentStats.total_downloaded || 0,
              all_time_upload: this.torrentStats.total_uploaded || 0,
              download_rate: this.torrentStats.total_download_speed || 0,
              upload_rate: this.torrentStats.total_upload_speed || 0
            };
            
            if (torrentsRes.ok) {
              const torrents = await torrentsRes.json();
              
              // Initialize lastTorrentData with current values for delta tracking
              torrents.forEach(t => {
                this.lastTorrentData.set(t.id, {
                  downloaded: t.downloaded || 0,
                  uploaded: t.uploaded || 0
                });
              });
            }
              // Get top 5 active torrents by speed
          } catch (error) {
            // Handle error silently
          }
        },
        
        logout() {
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/login.html';
        }
      };
    }
  </script>
</body>
</html>
